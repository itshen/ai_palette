<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Palette</title>
    <script>
        // åœ¨é¡µé¢åŠ è½½å‰åˆå§‹åŒ–ä¸»é¢˜
        (function() {
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            if (savedConfig.theme) {
                document.documentElement.classList.toggle('dark', savedConfig.theme === 'dark');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .gradient-bg {
                @apply dark:bg-gradient-to-br dark:from-slate-900 dark:to-slate-800 bg-gradient-to-br from-slate-50 to-slate-100;
            }
            .floating-image {
                @apply fixed left-8 top-8 w-[320px] rounded-lg shadow-lg transition-transform duration-300
                       hover:shadow-xl z-50;
                filter: drop-shadow(0 4px 12px rgba(0, 120, 255, 0.2));
            }
            .floating-image:hover {
                @apply -translate-y-1 rotate-1;
                filter: drop-shadow(0 8px 16px rgba(0, 120, 255, 0.3));
            }
            .github-corner:hover .octo-arm {
                animation: octocat-wave 560ms ease-in-out;
            }
            @keyframes octocat-wave {
                0%, 100% { transform: rotate(0) }
                20%, 60% { transform: rotate(-25deg) }
                40%, 80% { transform: rotate(10deg) }
            }
            .input-base {
                @apply w-full rounded-lg border shadow-sm backdrop-blur-sm px-4 py-3
                       dark:border-gray-700/50 dark:bg-gray-800/50 dark:text-gray-100
                       border-gray-200 bg-white/90 text-gray-900
                       dark:hover:border-blue-400/40 dark:hover:bg-gray-800/70
                       hover:border-blue-400/40 hover:bg-white
                       dark:focus:border-blue-400 dark:focus:bg-gray-800/90 dark:focus:ring-2 dark:focus:ring-blue-500/20
                       focus:border-blue-400 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:outline-none
                       transition-all duration-200;
            }
            .btn-primary {
                @apply w-full bg-gradient-to-r from-blue-500 to-blue-600
                       text-white py-3 px-4 rounded-lg font-medium
                       hover:opacity-90 active:opacity-80
                       transform active:scale-[0.99]
                       transition-all duration-200
                       shadow-sm hover:shadow-blue-500/10 focus:shadow-md focus:outline-none;
            }
            .label-text {
                @apply block text-sm font-medium mb-1.5
                       dark:text-gray-300 text-gray-700;
            }
            .response-box {
                @apply w-full rounded-lg p-4 min-h-[100px] whitespace-pre-wrap backdrop-blur-sm shadow-sm
                       dark:bg-gray-800/50 dark:border dark:border-gray-700/50 dark:text-gray-100
                       bg-white/90 border border-gray-200 text-gray-900;
            }
            select {
                @apply input-base appearance-none bg-no-repeat cursor-pointer pr-10;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 0.75rem center;
                background-size: 1.5em 1.5em;
            }
            input[type="checkbox"] {
                @apply w-5 h-5 rounded-md cursor-pointer transition-colors duration-200
                       focus:ring-0 focus:ring-offset-0
                       dark:border-gray-700 dark:bg-gray-800 dark:text-blue-500
                       border-gray-300 bg-white text-blue-500;
            }
            ::placeholder {
                @apply dark:text-gray-500 text-gray-400;
            }
            option {
                @apply dark:bg-gray-800 dark:text-gray-100 bg-white text-gray-900;
            }
            .reasoning-content {
                @apply overflow-hidden transition-all duration-300 ease-in-out;
            }
            .reasoning-arrow {
                @apply transform transition-transform duration-300 ease-in-out;
            }
            .breathing-button {
                @apply animate-pulse;
                animation: breathing 2s ease-in-out infinite;
            }
            
            @keyframes breathing {
                0% {
                    box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(147, 51, 234, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(147, 51, 234, 0);
                }
            }

            .thinking-label {
                @apply px-2 py-0.5;
                animation: thinkingBreathing 2s ease-in-out infinite;
            }
            
            @keyframes thinkingBreathing {
                0% {
                    color: rgb(244, 114, 182);
                    text-shadow: 0 0 5px rgba(244, 114, 182, 0.5);
                }
                50% {
                    color: rgb(236, 72, 153);
                    text-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
                }
                100% {
                    color: rgb(244, 114, 182);
                    text-shadow: 0 0 5px rgba(244, 114, 182, 0.5);
                }
            }

            .thinking-label.thinking-done {
                @apply text-slate-400;
                animation: none;
                text-shadow: none;
            }

            .thinking-text {
                @apply text-slate-400;
            }

            .code-block {
                @apply font-mono text-sm whitespace-pre;
            }
            .code-block code {
                @apply dark:text-slate-300 text-slate-700 whitespace-pre;
            }
            .drawer-open {
                @apply pr-[600px] transition-all duration-300 ease-in-out;
            }
            
            input:checked + .toggle-label {
                @apply dark:bg-blue-600 bg-blue-600;
            }
            
            input:checked + .toggle-label .toggle-dot {
                transform: translateX(1.5rem);
            }
        }
    </style>
</head>
<body class="dark:bg-slate-900 dark:text-slate-200 bg-slate-50 text-slate-900">
    <!-- æ¬¢è¿æ¨¡æ€æ¡† -->
    <div id="welcomeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="relative bg-white dark:bg-slate-800 rounded-xl max-w-lg w-full mx-4 p-6 shadow-xl transform transition-transform duration-300 scale-95">
            <div class="absolute top-4 right-4">
                <button onclick="closeWelcomeModal()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path d="M18 6l-12 12"></path>
                        <path d="M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <h2 class="text-2xl font-bold dark:text-white text-slate-900">æ¬¢è¿ä½¿ç”¨ AI Palette! ğŸ¨</h2>
                <div class="space-y-2">
                    <p class="dark:text-slate-300 text-slate-600">AI Palette æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„ AI æ¥å£å¹³å°ï¼Œæ”¯æŒå¤šç§å¹³å°ï¼š</p>
                    <ul class="list-disc pl-5 dark:text-slate-300 text-slate-600 space-y-1">
                        <li><span class="font-medium text-blue-500"><a href="https://cloud.siliconflow.cn/i/gQhQNfpv" target="_blank" class="text-blue-500 hover:text-blue-600">ç¡…åŸºæµåŠ¨</a></span> - æ¨èï¼æä¾›ä¸°å¯Œçš„æ¨¡å‹é€‰æ‹©ï¼Œå“åº”é€Ÿåº¦å¿«</li>
                        <li><span class="font-medium">Ollama</span> - æœ¬åœ°éƒ¨ç½²ï¼Œæ— éœ€ API Key</li>
                        <li><span class="font-medium">å…¶ä»–</span> - DeepSeekã€OpenAIã€æ™ºè°±ã€åƒé—®ç­‰ã€‚</li>
                    </ul>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4 space-y-2">
                    <p class="dark:text-slate-300 text-slate-600 font-medium">å¿«é€Ÿå¼€å§‹ï¼š</p>
                    <p class="dark:text-slate-400 text-slate-600">1. é€‰æ‹©å¹³å°ï¼ˆæ¨èä½¿ç”¨ç¡…åŸºæµåŠ¨ï¼Œå…è´¹ç”¨Qwen2.5ï¼‰</p>
                    <p class="dark:text-slate-400 text-slate-600">2. è¾“å…¥ API Keyï¼ˆ<a href="https://cloud.siliconflow.cn/i/gQhQNfpv" target="_blank" class="text-blue-500 hover:text-blue-600">ç‚¹å‡»è·å–</a>ï¼‰</p>
                    <p class="dark:text-slate-400 text-slate-600">3. å¼€å§‹å¯¹è¯ï¼</p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="dark:text-slate-300 text-slate-600">
                            <p class="font-medium">æœ‰ä»»ä½•æƒ³æ³•ï¼Ÿ</p>
                            <p class="text-sm mt-1">æ‰«æäºŒç»´ç å…³æ³¨æˆ‘ä»¬ï¼Œè·å–å¸®åŠ©å’Œæ›´æ–°ï¼</p>
                        </div>
                        <img src="/static/image/qrcode.jpg" alt="Connect" class="w-24 h-24 rounded-lg dark:border-slate-600 border-slate-200 border">
                    </div>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="closeWelcomeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-offset-white">
                        å¼€å§‹ä½¿ç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="flex h-screen">
        <!-- å·¦ä¾§è®¾ç½®é¢æ¿ -->
        <div class="w-80 border-r dark:border-slate-700 border-slate-200 dark:bg-slate-800 bg-white p-6 flex flex-col">
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-2xl font-bold dark:text-white text-slate-800">AI Palette ğŸ¨</h1>
                    <div class="flex">
                        <div class="rounded-md border dark:border-slate-200/20 border-slate-200">
                            <div class="flex text-[10px] font-medium leading-4">
                                <button onclick="toggleTheme('dark')" class="theme-toggle dark-toggle flex w-auto gap-1 rounded-l-md px-2 py-1 focus:outline-none dark:text-slate-300 text-slate-500 dark:hover:bg-slate-700/50 hover:bg-slate-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="inline-flex h-3.5 w-3.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                    </svg>
                                </button>
                                <button onclick="toggleTheme('light')" class="theme-toggle light-toggle flex gap-1 rounded-r-md px-2 py-1 focus:outline-none dark:text-slate-300 text-slate-500 dark:hover:bg-slate-700/50 hover:bg-slate-100">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" class="inline-flex h-3.5 w-3.5" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="dark:text-slate-400 text-slate-600 text-sm">ç»Ÿä¸€ AI æ¥å£ï¼Œä¸€ä¸ªè°ƒç”¨æ»¡è¶³æ‰€æœ‰éœ€æ±‚</p>
            </div>

            <!-- æ¨¡å‹è®¾ç½® -->
            <div class="space-y-4 flex-1">
                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">æ¨¡å‹æä¾›å•†</label>
                    <select id="modelType" onchange="handleModelTypeChange()" class="input-base">
                        <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="ollama">Ollama</option>
                        <option value="openai">OpenAI</option>
                        <option value="zhipu">æ™ºè°±AI</option>
                        <option value="dashscope">é€šä¹‰åƒé—®</option>
                        <option value="minimax">MiniMax</option>
                        <option value="ernie">ç™¾åº¦æ–‡å¿ƒ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKey" class="input-base" 
                            placeholder="è¾“å…¥ä½ çš„ API Key"
                            onblur="handleApiKeyChange()">
                        <button onclick="toggleApiKeyVisibility()" class="absolute right-2 top-1/2 -translate-y-1/2 dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                <path d="M12 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"></path>
                                <path d="M22 12c-2.667 4.667 -6 7 -10 7s-7.333 -2.333 -10 -7c2.667 -4.667 6 -7 10 -7s7.333 2.333 10 7"></path>
                            </svg>
                        </button>
                    </div>
                    <a id="apiKeyHelp" href="#" target="_blank" class="text-sm text-blue-500 hover:text-blue-600 mt-1 inline-block">
                        è·³è½¬å®˜ç½‘è·å– API Key
                    </a>
                </div>

                <div>
                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-1">æ¨¡å‹åç§°</label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="model" 
                            class="input-base pr-20" 
                            placeholder="é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°"
                            oninput="filterModels(this.value)"
                            onclick="showModelDropdown()"
                            autocomplete="off"
                        >
                        <button 
                            onclick="refreshModels()"
                            type="button"
                            class="absolute right-2 top-1/2 -translate-y-1/2 dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                <path d="M20 11a8.1 8.1 0 0 0 -15.5 -2m-.5 -4v4h4"></path>
                                <path d="M4 13a8.1 8.1 0 0 0 15.5 2m.5 4v-4h-4"></path>
                            </svg>
                        </button>
                        <!-- æ¨¡å‹åˆ—è¡¨ä¸‹æ‹‰æ¡† -->
                        <div id="modelDropdown" class="hidden absolute left-0 right-0 z-50 mt-1 max-h-60 overflow-auto rounded-lg dark:bg-slate-700 bg-white dark:border-slate-600 border-slate-200 border shadow-lg">
                            <div id="modelList" class="py-1">
                                <!-- æ¨¡å‹é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <!-- æ·»åŠ é…ç½®åŒé“¾æ¨ç†æŒ‰é’® -->
                    <div class="flex items-center justify-between dark:bg-slate-700/50 bg-slate-50 rounded-lg px-4 py-2">
                        <label class="text-sm font-medium dark:text-slate-300 text-slate-600">é…ç½®åŒé“¾æ¨ç†</label>
                        <button onclick="toggleChainModal()" class="flex items-center justify-center space-x-2 px-3 py-1.5 rounded-lg dark:bg-slate-600 bg-slate-200 dark:text-slate-300 text-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 transition-colors duration-200">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                            <span>é…ç½®</span>
                        </button>
                    </div>

                    <div class="flex items-center justify-between dark:bg-slate-700/50 bg-slate-50 rounded-lg px-4 py-2">
                        <label for="enableStreaming" class="text-sm font-medium dark:text-slate-300 text-slate-600">å¯ç”¨æµå¼è¾“å‡º</label>
                        <div class="relative inline-block w-12 h-6">
                            <input type="checkbox" id="enableStreaming" onchange="handleStreamingChange()" class="hidden">
                            <label for="enableStreaming" class="toggle-label block w-12 h-6 rounded-full dark:bg-slate-600 bg-slate-300 cursor-pointer relative transition-colors duration-300">
                                <span class="toggle-dot absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform duration-300 ease-in-out shadow-sm"></span>
                            </label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between dark:bg-slate-700/50 bg-slate-50 rounded-lg px-4 py-2">
                        <label for="showCodeExamples" class="text-sm font-medium dark:text-slate-300 text-slate-600">æ˜¾ç¤ºè°ƒç”¨ä»£ç ç¤ºä¾‹</label>
                        <div class="relative inline-block w-12 h-6">
                            <input type="checkbox" id="showCodeExamples" onchange="toggleCodeDrawer()" class="hidden">
                            <label for="showCodeExamples" class="toggle-label block w-12 h-6 rounded-full dark:bg-slate-600 bg-slate-300 cursor-pointer relative transition-colors duration-300">
                                <span class="toggle-dot absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform duration-300 ease-in-out shadow-sm"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨é“¾æ¥ -->
            <div class="mt-auto space-y-4">
                <!-- æ¸…é™¤å¯¹è¯å†å² -->
                <div>
                    <button onclick="clearAllMessages()" class="w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-lg bg-red-500/10 dark:text-red-400 text-red-600 hover:bg-red-500/20 dark:hover:bg-red-500/20 transition-colors duration-200 border dark:border-red-900/50 border-red-200">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        <span class="text-base">æ¸…ç©ºå¯¹è¯å†å²</span>
                    </button>
                </div>

                <!-- GitHub é“¾æ¥ -->
                <div class="text-center">
                    <a href="https://github.com/itshen/ai_palette" class="inline-flex items-center gap-2 text-sm font-medium dark:text-slate-200 text-slate-600 hover:text-blue-500 transition-colors duration-200" target="_blank">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/>
                        </svg>
                        GitHub ä»“åº“
                    </a>
                </div>
                <!-- äºŒç»´ç  -->
                <div>
                    <img src="/static/image/connect.jpg" alt="Connect" class="w-full rounded-lg dark:border-slate-600 border-slate-200 border">
                </div>
            </div>
        </div>

        <!-- å³ä¾§å¯¹è¯ç•Œé¢ -->
        <div class="flex-1 flex flex-col relative transition-all duration-300" id="chatContainer">
            <!-- åŒé“¾æ¨ç†é…ç½®æ¨¡æ€æ¡† -->
            <div id="chainModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
                <div class="relative bg-white dark:bg-slate-800 rounded-xl w-[80vw] h-[80vh] mx-4 shadow-xl transform transition-transform duration-300 scale-95 flex flex-col">
                    <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
                    <div class="absolute top-4 right-4">
                        <button onclick="toggleChainModal()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                                <path d="M18 6l-12 12"></path>
                                <path d="M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸ -->
                    <div class="flex flex-1 p-6 gap-6 overflow-hidden">
                        <!-- å·¦ä¾§åˆ—è¡¨ -->
                        <div class="w-1/4 flex flex-col dark:bg-slate-900 bg-slate-50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium dark:text-slate-200 text-slate-900">æ¨ç†é“¾åˆ—è¡¨</h3>
                                <button onclick="addNewChain()" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-200 rounded-lg dark:text-slate-400 text-slate-600" style="margin-right: 10px;">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                    </svg>
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto">
                                <ul id="chainList" class="space-y-2">
                                    <!-- åˆ—è¡¨é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                                </ul>
                            </div>
                        </div>

                        <!-- å³ä¾§ç¼–è¾‘åŒºåŸŸ -->
                        <div class="flex-1 flex flex-col ml-0"> 
                            <!-- å³ä¾§é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
                            <div class="flex items-center justify-between mb-4">
                                <h2 id="chainTitle" class="text-xl font-medium dark:text-slate-200 text-slate-900 px-2 py-1 rounded cursor-pointer" ondblclick="makeEditable(this)">æœªé€‰æ‹©æ¨ç†é“¾</h2>
                                <div class="flex gap-2 mr-8">
                                    <button class="px-4 py-2 rounded-lg dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200 transition-colors duration-200">
                                        å¯¼å…¥
                                    </button>
                                    <button class="px-4 py-2 rounded-lg dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200 transition-colors duration-200">
                                        å¯¼å‡º
                                    </button>
                                </div>
                            </div>

                            <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
                            <div class="flex-1 flex flex-col gap-4">
                                <!-- æ€è€ƒ prompt -->
                                <div class="flex-1">
                                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-2">æ€è€ƒ Prompt</label>
                                    <!-- æ€è€ƒ prompt çš„æ¨¡å‹é…ç½® -->
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <select id="thinkingModelType" class="input-base">
                                                <option value="inherit">ç»§æ‰¿ä¸»é…ç½®</option>
                                                <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                                                <option value="deepseek">DeepSeek</option>
                                                <option value="ollama">Ollama</option>
                                                <option value="openai">OpenAI</option>
                                                <option value="zhipu">æ™ºè°±AI</option>
                                                <option value="dashscope">é€šä¹‰åƒé—®</option>
                                                <option value="minimax">MiniMax</option>
                                                <option value="ernie">ç™¾åº¦æ–‡å¿ƒ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <input type="text" id="thinkingModel" class="input-base" placeholder="æ¨¡å‹åç§°ï¼ˆç»§æ‰¿æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰">
                                        </div>
                                        <div>
                                            <input type="password" id="thinkingApiKey" class="input-base" placeholder="API Keyï¼ˆç»§æ‰¿æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰">
                                        </div>
                                    </div>
                                    <textarea 
                                        id="thinkingPrompt" 
                                        class="w-full h-[calc(100%-6rem)] rounded-lg border shadow-sm px-4 py-3 dark:bg-slate-900 bg-slate-50 dark:text-slate-200 text-slate-900 dark:border-slate-700 border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                                        placeholder="è¾“å…¥æ€è€ƒè¿‡ç¨‹çš„ prompt..."
                                    ></textarea>
                                </div>

                                <!-- ç»“æœ prompt -->
                                <div class="flex-1">
                                    <label class="block text-sm font-medium dark:text-slate-300 text-slate-600 mb-2">ç»“æœ Prompt</label>
                                    <!-- ç»“æœ prompt çš„æ¨¡å‹é…ç½® -->
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <select id="resultModelType" class="input-base">
                                                <option value="inherit">ç»§æ‰¿ä¸»é…ç½®</option>
                                                <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                                                <option value="deepseek">DeepSeek</option>
                                                <option value="ollama">Ollama</option>
                                                <option value="openai">OpenAI</option>
                                                <option value="zhipu">æ™ºè°±AI</option>
                                                <option value="dashscope">é€šä¹‰åƒé—®</option>
                                                <option value="minimax">MiniMax</option>
                                                <option value="ernie">ç™¾åº¦æ–‡å¿ƒ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <input type="text" id="resultModel" class="input-base" placeholder="æ¨¡å‹åç§°ï¼ˆç»§æ‰¿æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰">
                                        </div>
                                        <div>
                                            <input type="password" id="resultApiKey" class="input-base" placeholder="API Keyï¼ˆç»§æ‰¿æˆ–æ‰‹åŠ¨è¾“å…¥ï¼‰">
                                        </div>
                                    </div>
                                    <textarea 
                                        id="resultPrompt" 
                                        class="w-full h-[calc(100%-6rem)] rounded-lg border shadow-sm px-4 py-3 dark:bg-slate-900 bg-slate-50 dark:text-slate-200 text-slate-900 dark:border-slate-700 border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/20"
                                        placeholder="è¾“å…¥ç”Ÿæˆç»“æœçš„ prompt..."
                                    ></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»£ç ç¤ºä¾‹æŠ½å±‰ -->
            <div id="codeDrawer" class="fixed right-0 top-0 h-full w-[600px] transform translate-x-full transition-all duration-300 ease-in-out bg-white dark:bg-slate-800 shadow-xl border-l dark:border-slate-700 border-slate-200 flex flex-col">
                <div class="flex items-center justify-between p-4 border-b dark:border-slate-700 border-slate-200">
                    <h3 class="text-lg font-medium dark:text-slate-200 text-slate-900">ä»£ç ç¤ºä¾‹</h3>
                    <button onclick="toggleCodeDrawer()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                            <path d="M18 6l-12 12"></path>
                            <path d="M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-4">
                    <!-- å‰ç«¯ä»£ç ç¤ºä¾‹ -->
                    <div class="mb-8">
                        <h4 class="text-base font-medium dark:text-slate-200 text-slate-900 mb-4">å‰ç«¯è°ƒç”¨ç¤ºä¾‹</h4>
                        <div class="mb-4">
                            <select id="frontendCodeType" onchange="switchCodeExample('frontend')" class="input-base">
                                <option value="curl">cURL</option>
                                <option value="requests">Python 3.x - Requests</option>
                                <option value="fetch">JavaScript (Fetch)</option>
                                <option value="eventsource">JavaScript (EventSource)</option>
                            </select>
                        </div>

                        <div id="frontendExamples">
                            <!-- cURL -->
                            <div id="curlExample" class="code-example">
                                <div class="relative">
                                    <div class="absolute right-2 top-2">
                                        <button onclick="copyCode(this)" class="text-xs px-2 py-1 rounded dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200">
                                            å¤åˆ¶ä»£ç 
                                        </button>
                                    </div>
                                    <pre class="code-block dark:bg-slate-900 bg-slate-50 rounded-lg p-4 text-sm overflow-x-auto">
<code class="language-bash">curl -X POST http://localhost:18000/api/chat \\
-H "Content-Type: application/json" \\
-d '{
    "model_type": "[$MODEL_TYPE$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    "model": "[$MODEL$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
    "api_key": "[$API_KEY$]",  // å½“å‰è¾“å…¥çš„ API Key
    "prompt": "Your message here",
    "enable_streaming": [$STREAMING$]  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
}'</code></pre>
                                </div>
                            </div>

                            <!-- Python Requests -->
                            <div id="requestsExample" class="code-example hidden">
                                <div class="relative">
                                    <div class="absolute right-2 top-2">
                                        <button onclick="copyCode(this)" class="text-xs px-2 py-1 rounded dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200">
                                            å¤åˆ¶ä»£ç 
                                        </button>
                                    </div>
                                    <pre class="code-block dark:bg-slate-900 bg-slate-50 rounded-lg p-4 text-sm overflow-x-auto">
<code class="language-python">import requests

response = requests.post(
    'http://localhost:18000/api/chat',
    json={
        'model_type': "[$MODEL_TYPE$]",  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
        'model': "[$MODEL$]",  # å½“å‰é€‰æ‹©çš„æ¨¡å‹
        'api_key': "[$API_KEY$]",  # å½“å‰è¾“å…¥çš„ API Key
        'prompt': 'Your message here',
        'enable_streaming': True if '[$STREAMING$]' == 'true' else False  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
    }
)

print(response.json()['response'])</code></pre>
                                </div>
                            </div>
                            
                            <!-- JavaScript (Fetch) -->
                            <div id="fetchExample" class="code-example hidden">
                                <div class="relative">
                                    <div class="absolute right-2 top-2">
                                        <button onclick="copyCode(this)" class="text-xs px-2 py-1 rounded dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200">
                                            å¤åˆ¶ä»£ç 
                                        </button>
                                    </div>
                                    <pre class="code-block dark:bg-slate-900 bg-slate-50 rounded-lg p-4 text-sm overflow-x-auto">
<code class="language-javascript">const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        model_type: "[$MODEL_TYPE$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
        model: "[$MODEL$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
        api_key: "[$API_KEY$]",  // å½“å‰è¾“å…¥çš„ API Key
        prompt: 'Your message here',
        enable_streaming: True if '[$STREAMING$]' == 'true' else False  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
    })
});

const data = await response.json();
console.log(data.response);</code></pre>
                                </div>
                            </div>
                            
                            <!-- JavaScript (EventSource) -->
                            <div id="eventsourceExample" class="code-example hidden">
                                <div class="relative">
                                    <div class="absolute right-2 top-2">
                                        <button onclick="copyCode(this)" class="text-xs px-2 py-1 rounded dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200">
                                            å¤åˆ¶ä»£ç 
                                        </button>
                                    </div>
                                    <pre class="code-block dark:bg-slate-900 bg-slate-50 rounded-lg p-4 text-sm overflow-x-auto">
<code class="language-javascript">const params = new URLSearchParams({
    model_type: "[$MODEL_TYPE$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    model: "[$MODEL$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
    api_key: "[$API_KEY$]",  // å½“å‰è¾“å…¥çš„ API Key
    prompt: 'Your message here',
    enable_streaming: true  // æµå¼è¾“å‡ºå§‹ç»ˆå¯ç”¨
});

const eventSource = new EventSource(\`/api/chat?\${params}\`);

eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(data.content);
};

eventSource.onerror = () => {
    eventSource.close();
};</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åç«¯ä»£ç ç¤ºä¾‹ -->
                    <div>
                        <h4 class="text-base font-medium dark:text-slate-200 text-slate-900 mb-4">åç«¯è°ƒç”¨ç¤ºä¾‹</h4>
                        <div class="relative">
                            <div class="absolute right-2 top-2">
                                <button onclick="copyCode(this)" class="text-xs px-2 py-1 rounded dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 dark:hover:bg-slate-600 hover:bg-slate-200">
                                    å¤åˆ¶ä»£ç 
                                </button>
                            </div>
                            <pre class="code-block dark:bg-slate-900 bg-slate-50 rounded-lg p-4 text-sm overflow-x-auto">
<code class="language-python">from ai_palette import AIChat

# åˆå§‹åŒ–èŠå¤©å®ä¾‹
chat = AIChat(
    provider="[$MODEL_TYPE$]",  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    model="[$MODEL$]",  # å½“å‰é€‰æ‹©çš„æ¨¡å‹
    api_key="[$API_KEY$]",  # å½“å‰è¾“å…¥çš„ API Key
    enable_streaming=True if '[$STREAMING$]' == 'true' else False  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
)

# å‘é€æ¶ˆæ¯
response = chat.ask("Your message here")
print(response)

# æµå¼è¾“å‡º
for chunk in chat.ask("Your message here"):
    print(chunk["content"], end="", flush=True)</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-4" id="messageList">
                <!-- å¯¹è¯å»ºè®® -->
                <div id="suggestionBox" class="mb-4">
                    <div class="flex flex-wrap gap-2 text-xs">
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¸®æˆ‘åˆ¶å®šä¸€ä»½ä¸€å‘¨å¥åº·é¥®é£Ÿè®¡åˆ’
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¦‚ä½•ç¼“è§£å·¥ä½œå‹åŠ›å’Œæƒ…ç»ª
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            æ¨èä¸€äº›å®¤å†…æ¤ç‰©å…»æŠ¤å°æŠ€å·§
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            åˆ†äº«ä¸€äº›æé«˜ç¡çœ è´¨é‡çš„æ–¹æ³•
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            æ¨èå‡ é“ç®€å•ç¾å‘³çš„å®¶å¸¸èœ
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            å¦‚ä½•æ•´ç†å’Œæ”¶çº³å°æˆ·å‹ç©ºé—´
                        </button>
                        <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                            åˆ†äº«ä¸€äº›çœé’±å°å¦™æ‹›
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥æ¡† -->
            <div class="p-4 border-t dark:border-slate-700 border-slate-200">
                <form onsubmit="sendMessage(); return false;">
                    <div class="relative">
                        <textarea 
                            id="prompt" 
                            class="input-base pr-24 resize-none"
                            rows="3"
                            placeholder="è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜..."
                        ></textarea>
                        <button 
                            type="submit"
                            class="absolute bottom-3 right-3 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-offset-white"
                        >
                            å‘é€
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // åœ¨ç°æœ‰çš„ window.onload å‡½æ•°å¼€å¤´æ·»åŠ 
        window.onload = function() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡è®¿é—®
            const hasVisited = localStorage.getItem('hasVisitedAIPalette');
            if (!hasVisited) {
                showWelcomeModal();
                localStorage.setItem('hasVisitedAIPalette', 'true');
            }

            // æ¢å¤èŠå¤©è®°å½•
            restoreChatHistory();

            // åŠ è½½å·²ä¿å­˜çš„é…ç½®
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            
            // æ¢å¤æ¨¡å‹ç±»å‹
            if (savedConfig.modelType) {
                const modelTypeSelect = document.getElementById('modelType');
                modelTypeSelect.value = savedConfig.modelType;
            }
            
            // æ¢å¤ API Key
            const modelType = document.getElementById('modelType').value;
            if (savedConfig[`${modelType}_apiKey`]) {
                document.getElementById('apiKey').value = savedConfig[`${modelType}_apiKey`];
            }
            
            // æ¢å¤æ¨¡å‹é€‰æ‹©
            if (savedConfig[`${modelType}_lastModel`]) {
                document.getElementById('model').value = savedConfig[`${modelType}_lastModel`];
            }
            
            // æ¢å¤æµå¼è¾“å‡ºè®¾ç½®
            if (savedConfig.hasOwnProperty('enableStreaming')) {
                document.getElementById('enableStreaming').checked = savedConfig.enableStreaming;
            }
            
            // æ¢å¤ä¸»é¢˜è®¾ç½®
            if (savedConfig.theme) {
                toggleTheme(savedConfig.theme);
            } else {
                // æ£€æµ‹ç³»ç»Ÿä¸»é¢˜å¹¶è®¾ç½®åˆå§‹çŠ¶æ€
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                    document.documentElement.classList.remove('dark');
                    updateThemeButtons('light');
                } else {
                    updateThemeButtons('dark');
                }
            }

            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                    updateThemeButtons('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    updateThemeButtons('light');
                }
            });

            // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶æ›´æ–° API Key å¸®åŠ©é“¾æ¥
            updateApiKeyHelpLink();
            
            // åˆå§‹åŒ–ä»£ç ç¤ºä¾‹
            updateCodeExamples();
            
            // åˆå§‹åŒ–å‰ç«¯ä»£ç ç¤ºä¾‹åˆ‡æ¢
            switchCodeExample('frontend');
            
            // è®¾ç½®é…ç½®ç›‘å¬
            setupConfigListeners();
            
            // ç›‘å¬ä¸»é¢˜åˆ‡æ¢,ç¡®ä¿ä»£ç ç¤ºä¾‹æ ·å¼åŒæ­¥
            const observer = new MutationObserver(() => {
                requestAnimationFrame(() => {
                    updateCodeExamples();
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
            
            // åˆå§‹åŒ–ååˆ·æ–°æ¨¡å‹åˆ—è¡¨
            refreshModels();
        };

        // æ˜¾ç¤ºæ¬¢è¿æ¨¡æ€æ¡†
        function showWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            modal.style.opacity = '1';
            modal.style.pointerEvents = 'auto';
            const modalContent = modal.querySelector('.scale-95');
            setTimeout(() => {
                modalContent.classList.remove('scale-95');
                modalContent.classList.add('scale-100');
            }, 10);
        }

        // å…³é—­æ¬¢è¿æ¨¡æ€æ¡†
        function closeWelcomeModal() {
            const modal = document.getElementById('welcomeModal');
            const modalContent = modal.querySelector('.scale-100, .scale-95');
            if (modalContent) {
                modalContent.classList.remove('scale-100');
                modalContent.classList.add('scale-95');
            }
            setTimeout(() => {
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none';
            }, 200);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('welcomeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeWelcomeModal();
            }
        });

        // æ¨¡å‹é…ç½®
        const modelConfigs = {
            'openai': ['gpt-4o-mini', 'gpt-4o', 'gpt-3.5-turbo'],
            'ernie': ['ernie-bot', 'ernie-bot-4'],
            'dashscope': ['qwen-turbo', 'qwen-plus', 'qwen-max'],
            'zhipu': ['GLM-4-Plus', 'GLM-4-Flash'],
            'minimax': ['abab6.5-chat', 'abab7-preview'],
            'ollama': [],
            'deepseek': ['deepseek-coder', 'deepseek-chat'],
            'siliconflow': ['deepseek-ai/DeepSeek-R1', 'Qwen/Qwen2.5-7B-Instruct']
        };

        // å­˜å‚¨æ‰€æœ‰æ¨¡å‹åˆ—è¡¨
        let allModels = [];
        
        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            const modelList = document.getElementById('modelList');
            const modelInput = document.getElementById('model');
            const modelDropdown = document.getElementById('modelDropdown');
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                modelInput.placeholder = 'åŠ è½½ä¸­...';
                modelInput.disabled = true;
                
                const response = await fetch(`/api/models?type=${modelType}&api_key=${apiKey}`);
                const data = await response.json();
                
                if (data.success) {
                    allModels = data.models || [];
                    
                    // æ›´æ–°æ¨¡å‹åˆ—è¡¨
                    modelList.innerHTML = '';
                    
                    if (allModels.length === 0) {
                        const noModels = document.createElement('div');
                        noModels.className = 'px-4 py-2 dark:text-slate-400 text-slate-500 text-center';
                        noModels.textContent = 'æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹';
                        modelList.appendChild(noModels);
                        modelInput.placeholder = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹';
                        modelDropdown.classList.add('hidden');
                    } else {
                        allModels.forEach(model => {
                            const option = document.createElement('div');
                            option.className = 'px-4 py-2 dark:hover:bg-slate-600 hover:bg-slate-100 cursor-pointer dark:text-slate-200 text-slate-700';
                            option.textContent = model;
                            option.onclick = () => {
                                modelInput.value = model;
                                modelDropdown.classList.add('hidden');
                                
                                // ä¿å­˜é€‰æ‹©
                                const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                                config[`${modelType}_lastModel`] = model;
                                localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
                                
                                // æ›´æ–°ä»£ç ç¤ºä¾‹
                                updateCodeExamples();
                            };
                            modelList.appendChild(option);
                        });
                        
                        modelInput.placeholder = 'é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°';
                        // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                        modelDropdown.classList.remove('hidden');
                    }
                } else {
                    showError(data.error || 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');
                    modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                    allModels = [];
                    modelDropdown.classList.add('hidden');
                }
            } catch (error) {
                showError('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
                modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                allModels = [];
                modelDropdown.classList.add('hidden');
            } finally {
                modelInput.disabled = false;
            }
        }
        
        // ä¿®æ”¹è¿‡æ»¤æ¨¡å‹åˆ—è¡¨å‡½æ•°
        function filterModels(query) {
            const dropdown = document.getElementById('modelDropdown');
            const modelList = document.getElementById('modelList');
            
            if (!allModels || allModels.length === 0) {
                refreshModels();
                return;
            }
            
            const filteredModels = allModels.filter(model => 
                model.toLowerCase().includes(query.toLowerCase())
            );
            
            // æ›´æ–°æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
            modelList.innerHTML = '';
            
            if (filteredModels.length === 0) {
                const noModels = document.createElement('div');
                noModels.className = 'px-4 py-2 dark:text-slate-400 text-slate-500 text-center';
                noModels.textContent = 'æ²¡æœ‰åŒ¹é…çš„æ¨¡å‹';
                modelList.appendChild(noModels);
            } else {
                filteredModels.forEach(model => {
                    const option = document.createElement('div');
                    option.className = 'px-4 py-2 dark:hover:bg-slate-600 hover:bg-slate-100 cursor-pointer dark:text-slate-200 text-slate-700';
                    option.textContent = model;
                    option.onclick = () => {
                        document.getElementById('model').value = model;
                        dropdown.classList.add('hidden');
                        
                        // ä¿å­˜é€‰æ‹©
                        const modelType = document.getElementById('modelType').value;
                        const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                        config[`${modelType}_lastModel`] = model;
                        localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
                        
                        // æ›´æ–°ä»£ç ç¤ºä¾‹
                        updateCodeExamples();
                    };
                    modelList.appendChild(option);
                });
            }
            
            // æ˜¾ç¤ºä¸‹æ‹‰æ¡†
            dropdown.classList.remove('hidden');
        }
        
        // ä¿®æ”¹æ˜¾ç¤ºæ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨å‡½æ•°
        function showModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            const modelInput = document.getElementById('model');
            
            // å¦‚æœè¿˜æ²¡æœ‰æ¨¡å‹åˆ—è¡¨æ•°æ®ï¼Œå…ˆè·å–
            if (allModels.length === 0) {
                refreshModels();
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
                filterModels(modelInput.value);
            }
        }
        
        // æ›´æ–°æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
        function updateModelList(models) {
            const modelList = document.getElementById('modelList');
            modelList.innerHTML = '';
            
            if (models.length === 0) {
                const noModels = document.createElement('div');
                noModels.className = 'px-4 py-2 dark:text-slate-400 text-slate-500 text-center';
                noModels.textContent = 'æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹';
                modelList.appendChild(noModels);
                return;
            }
            
            models.forEach(model => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 dark:hover:bg-slate-600 hover:bg-slate-100 cursor-pointer dark:text-slate-200 text-slate-700';
                option.textContent = model;
                option.onclick = () => {
                    document.getElementById('model').value = model;
                    document.getElementById('modelDropdown').classList.add('hidden');
                    
                    // ä¿å­˜é€‰æ‹©
                    const modelType = document.getElementById('modelType').value;
                    const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                    config[`${modelType}_lastModel`] = model;
                    localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
                };
                modelList.appendChild(option);
            });
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            // åˆ›å»ºé”™è¯¯æç¤º
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 flex w-full max-w-md items-start justify-between rounded-xl dark:bg-slate-800 bg-white p-4 shadow-xl border dark:border-slate-700 border-slate-200';
            errorDiv.innerHTML = `
                <div class="flex gap-2 sm:gap-4">
                    <span class="text-red-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                            <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                            <path d="M12 9v4"></path>
                            <path d="M12 16v.01"></path>
                        </svg>
                    </span>
                    <div class="flex-1">
                        <strong class="block font-medium dark:text-slate-200 text-slate-900">é”™è¯¯</strong>
                        <p class="mt-1 text-sm dark:text-slate-300 text-slate-600">${message}</p>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" class="dark:text-slate-400 text-slate-500 dark:hover:text-slate-300 hover:text-slate-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none">
                        <path d="M18 6l-12 12"></path>
                        <path d="M6 6l12 12"></path>
                    </svg>
                </button>
            `;
            document.body.appendChild(errorDiv);
            
            // æ·»åŠ è¿›å…¥åŠ¨ç”»
            errorDiv.style.opacity = '0';
            errorDiv.style.transform = 'translateY(-20px)';
            errorDiv.style.transition = 'all 0.3s ease-out';
            
            // å¼ºåˆ¶é‡ç»˜
            errorDiv.offsetHeight;
            
            // æ˜¾ç¤º
            errorDiv.style.opacity = '1';
            errorDiv.style.transform = 'translateY(0)';
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                errorDiv.style.opacity = '0';
                errorDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
        
        // ä¿®æ”¹å¤„ç†æ¨¡å‹ç±»å‹å˜åŒ–çš„å‡½æ•°
        async function handleModelTypeChange() {
            const modelType = document.getElementById('modelType').value;
            const apiKeyInput = document.getElementById('apiKey');
            const modelInput = document.getElementById('model');
            
            // æ›´æ–°å¸®åŠ©é“¾æ¥
            updateApiKeyHelpLink();
            
            // ä»æœ¬åœ°å­˜å‚¨è·å–è¯¥æ¨¡å‹ç±»å‹çš„ä¸Šæ¬¡é…ç½®
            const savedConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            
            // æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„ API Key
            apiKeyInput.value = savedConfig[`${modelType}_apiKey`] || '';
            
            // æ¢å¤ä¸Šæ¬¡ä½¿ç”¨çš„æ¨¡å‹
            modelInput.value = savedConfig[`${modelType}_lastModel`] || '';
            
            // æ¸…ç©ºå½“å‰æ¨¡å‹åˆ—è¡¨
            allModels = [];
            document.getElementById('modelDropdown').classList.add('hidden');
            
            // ä¿å­˜é…ç½®å¹¶æ›´æ–°ä»£ç ç¤ºä¾‹
            saveConfig();
            requestAnimationFrame(() => {
                updateCodeExamples();
            });
            
            // è‡ªåŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            refreshModels();
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('modelDropdown');
            const modelInput = document.getElementById('model');
            const refreshButton = modelInput.nextElementSibling;
            
            if (!modelInput.contains(e.target) && !refreshButton.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // ç›‘å¬æ¨¡å‹è¾“å…¥æ¡†ç‚¹å‡»äº‹ä»¶
        document.getElementById('model').addEventListener('click', function() {
            if (allModels.length > 0) {
                filterModels(this.value);
            }
        });

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const modelType = document.getElementById('modelType').value;
            const currentModel = document.getElementById('model').value;
            const currentApiKey = document.getElementById('apiKey').value;
            const enableStreaming = document.getElementById('enableStreaming').checked;
            
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            
            config.modelType = modelType;
            config[`${modelType}_apiKey`] = currentApiKey;
            config[`${modelType}_lastModel`] = currentModel;
            config.enableStreaming = enableStreaming;
            
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
        }

        // åˆ‡æ¢ API Key æ˜¾ç¤º/éšè—
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
        }

        // æ›´æ–° API Key å¸®åŠ©é“¾æ¥
        function updateApiKeyHelpLink() {
            const modelType = document.getElementById('modelType').value || 'siliconflow';  // æ·»åŠ é»˜è®¤å€¼
            const helpLink = document.getElementById('apiKeyHelp');
            
            const helpLinks = {
                'openai': 'https://platform.openai.com/api-keys',
                'ernie': 'https://console.bce.baidu.com/qianfan/overview',
                'dashscope': 'https://bailian.console.aliyun.com/?apiKey=1',
                'zhipu': 'https://open.bigmodel.cn/usercenter/apikeys',
                'minimax': 'https://platform.minimaxi.com/user-center/basic-information/interface-key',
                'ollama': 'https://ollama.com',
                'deepseek': 'https://platform.deepseek.com/',
                'siliconflow': 'https://cloud.siliconflow.cn/i/gQhQNfpv'
            };
            
            helpLink.href = helpLinks[modelType] || helpLinks['siliconflow'];  // æ·»åŠ é»˜è®¤å€¼
            helpLink.style.display = (modelType === 'ollama') ? 'none' : 'inline-block';
        }

        // ä¿®æ”¹ escapeHtml å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(match) {
                const escape = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                };
                return escape[match];
            });
        }

        // ä¿®æ”¹ parseMarkdown å‡½æ•°
        function parseMarkdown(text) {
            if (!text) return '';
            
            // å…ˆè½¬ä¹‰ HTML
            text = escapeHtml(text);
            
            // å¤„ç†åŠ ç²— **text**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // å¤„ç†æ ‡é¢˜ ### text
            text = text.replace(/^###### (.*?)$/gm, '<h6 class="text-sm font-bold my-3">$1</h6>');
            text = text.replace(/^##### (.*?)$/gm, '<h5 class="text-base font-bold my-3">$1</h5>');
            text = text.replace(/^#### (.*?)$/gm, '<h4 class="text-lg font-bold my-3">$1</h4>');
            text = text.replace(/^### (.*?)$/gm, '<h3 class="text-xl font-bold my-3">$1</h3>');
            text = text.replace(/^## (.*?)$/gm, '<h2 class="text-2xl font-bold my-3">$1</h2>');
            text = text.replace(/^# (.*?)$/gm, '<h1 class="text-3xl font-bold my-4">$1</h1>');
            
            // å¤„ç†åˆ—è¡¨ - text
            text = text.replace(/^- (.*?)$/gm, '<li class="ml-4">$1</li>');
            
            // å¤„ç†åˆ†éš”çº¿ ---
            text = text.replace(/^---$/gm, '<hr class="my-4 border-t dark:border-slate-700 border-slate-200">');
            
            // å¤„ç†ä»£ç å—
            text = text.replace(/```(.*?)\n([\s\S]*?)```/g, function(match, lang, code) {
                return `<pre class="bg-slate-100 dark:bg-slate-800 rounded-lg p-3 my-2"><code class="language-${lang}">${code}</code></pre>`;
            });
            
            // å¤„ç†è¡Œå†…ä»£ç 
            text = text.replace(/`([^`]+)`/g, '<code class="bg-slate-100 dark:bg-slate-800 px-1 rounded">$1</code>');
            
            // å¤„ç†æ¢è¡Œï¼Œä¿æŒåŸæœ‰çš„æ¢è¡Œ
            text = text.split('\n').map(line => {
                if (!line.startsWith('<') && line.trim() !== '') {
                    return `<p class="mb-1">${line}</p>`;
                }
                return line;
            }).join('\n');
            
            return text;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const messageList = document.getElementById('messageList');
            const prompt = document.getElementById('prompt').value;
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('model').value;
            const enableStreaming = document.getElementById('enableStreaming').checked;

            if (!prompt) return;

            // éšè—å»ºè®®æ¡†
            const suggestionBox = document.getElementById('suggestionBox');
            if (suggestionBox) {
                suggestionBox.remove();  // å®Œå…¨ç§»é™¤å»ºè®®æ¡†
            }

            // æ¸…é™¤å…¨å±€å˜é‡
            window.currentResponse = '';
            window.currentReasoning = '';
            window.isThinking = false;

            // ä¿å­˜é…ç½®
            saveConfig();

            // æ”¶é›†ä¸Šä¸‹æ–‡
            let context = [];
            // å¦‚æœæ˜¯é‡æ–°å‘èµ·çš„å¯¹è¯ï¼Œä½¿ç”¨ä¿å­˜çš„ä¸Šä¸‹æ–‡
            if (window.reaskContext) {
                context = window.reaskContext;
                window.reaskContext = null;  // ä½¿ç”¨åæ¸…é™¤
            } else {
                // æ­£å¸¸æ”¶é›†ä¸Šä¸‹æ–‡
                const messages = messageList.children;
                for (const message of messages) {
                    if (message.querySelector('.bg-blue-600')) {  // ç”¨æˆ·æ¶ˆæ¯
                        const pElement = message.querySelector('p');
                        context.push({
                            role: 'user',
                            content: pElement.dataset.originalContent || pElement.textContent.replace(/<br\s*\/?>/g, '\n')
                        });
                    } else if (message.querySelector('.bg-purple-600')) {  // AI æ¶ˆæ¯
                        const responseElement = message.querySelector('pre');
                        if (responseElement && responseElement.textContent && responseElement.textContent !== '...') {
                            context.push({
                                role: 'assistant',
                                content: responseElement.dataset.originalContent || responseElement.textContent.replace(/<br\s*\/?>/g, '\n')
                            });
                        }
                    }
                }
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'flex items-start space-x-3 mb-4';
            // å…ˆè½¬ä¹‰å†…å®¹ï¼Œå†å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br/>
            const escapedContent = escapeHtml(prompt);
            const displayContent = escapedContent.replace(/\n/g, '<br/>');
            userMessage.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-white">U</div>
                <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                    <p class="dark:text-slate-200 text-slate-700" data-original-content="${escapeHtml(prompt)}">${displayContent}</p>
                </div>
            `;

            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
            const messages = JSON.parse(localStorage.getItem('aiPaletteChatHistory') || '[]');
            messages.push({
                type: 'user',
                content: prompt  // ä¿å­˜åŸå§‹å†…å®¹
            });
            localStorage.setItem('aiPaletteChatHistory', JSON.stringify(messages));

            messageList.appendChild(userMessage);

            // æ·»åŠ  AI å›å¤å®¹å™¨
            const aiMessage = addAIMessage(prompt);
            messageList.appendChild(aiMessage);

            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('prompt').value = '';

            // å‘é€è¯·æ±‚
            try {
                if (enableStreaming) {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_type: modelType,
                            api_key: apiKey,
                            model: model,
                            prompt: prompt,
                            enable_streaming: true,
                            include_reasoning: true,
                            context: context
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    const responseElement = aiMessage.querySelector('pre');
                    const reasoningElement = aiMessage.querySelector('div[id^="ai-reasoning"]');
                    responseElement.textContent = '';
                    window.currentResponse = '';  // æ¸…é™¤ç¼“å­˜

                    while (true) {
                        const {value, done} = await reader.read();
                        if (done) {
                            // ç§»é™¤å‘¼å¸ç¯æ•ˆæœ
                            document.querySelector('button[type="submit"]').classList.remove('breathing-button');
                            saveChatHistory();
                            break;
                        }

                        const text = decoder.decode(value);
                        const lines = text.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                                    if (data.type === 'reasoning') {
                                        // å¦‚æœè¿˜æ²¡æœ‰æ€è€ƒå®¹å™¨,åˆ›å»ºä¸€ä¸ª
                                        if (!reasoningElement.querySelector('.reasoning-content')) {
                                            reasoningElement.innerHTML = `
                                                <div class="text-slate-400">
                                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(90deg)">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                        </svg>
                                                        <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                                                    </div>
                                                    <div class="pl-5 mt-2 reasoning-content" style="height: auto; transition: height 0.3s">
                                                        <div class="whitespace-pre-wrap text-slate-400"></div>
                                                    </div>
                                                </div>`;
                                        }
                                        
                                        // æ·»åŠ å†…å®¹
                                        const reasoningContent = reasoningElement.querySelector('.reasoning-content');
                                        const reasoningDiv = reasoningContent.querySelector('div');
                                        const text = data.content;
                                        // ç´¯ç§¯æ¨ç†å†…å®¹
                                        if (!window.currentReasoning) window.currentReasoning = '';
                                        window.currentReasoning += text;
                                        // ä¿å­˜åŸå§‹å†…å®¹
                                        reasoningDiv.dataset.originalContent = window.currentReasoning;
                                        // åº”ç”¨ markdown è§£æ
                                        reasoningDiv.innerHTML = parseMarkdown(window.currentReasoning);
                                    } else if (data.type === 'content') {
                                        // å¦‚æœæ˜¯<think>ä¸”æ²¡æœ‰æ€è€ƒå®¹å™¨,åˆ›å»ºä¸€ä¸ª
                                        if (data.content === '<think>' && !reasoningElement.querySelector('.reasoning-content')) {
                                            reasoningElement.innerHTML = `
                                                <div class="text-slate-400">
                                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(90deg)">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                        </svg>
                                                        <span class="thinking-label">æ€è€ƒè¿‡ç¨‹</span>
                                                    </div>
                                                    <div class="pl-5 mt-2 reasoning-content" style="height: auto; transition: height 0.3s">
                                                        <div class="whitespace-pre-wrap text-slate-400"></div>
                                                    </div>
                                                </div>`;
                                            window.isThinking = true;
                                        }
                                        // å¦‚æœæ˜¯</think>,æ”¶èµ·æ€è€ƒè¿‡ç¨‹
                                        else if (data.content === '</think>') {
                                            window.isThinking = false;
                                        }
                                        // å¦‚æœåœ¨æ€è€ƒè¿‡ç¨‹ä¸­,å†…å®¹æ·»åŠ åˆ°æ€è€ƒè¿‡ç¨‹ä¸­
                                        else if (window.isThinking && reasoningElement.querySelector('.reasoning-content')) {
                                            const reasoningContent = reasoningElement.querySelector('.reasoning-content');
                                            const reasoningDiv = reasoningContent.querySelector('div');
                                            const text = data.content;
                                            // ç´¯ç§¯æ¨ç†å†…å®¹
                                            if (!window.currentReasoning) window.currentReasoning = '';
                                            window.currentReasoning += text;
                                            // åº”ç”¨ markdown è§£æ
                                            reasoningDiv.innerHTML = parseMarkdown(window.currentReasoning);
                                        }
                                        // å…¶ä»–æƒ…å†µ,æ˜¾ç¤ºåœ¨å“åº”åŒºåŸŸ
                                        else {
                                            // åœæ­¢æ€è€ƒæ ‡ç­¾çš„åŠ¨ç”»
                                            const thinkingLabel = reasoningElement.querySelector('.thinking-label');
                                            if (thinkingLabel) {
                                                thinkingLabel.classList.add('thinking-done');
                                            }
                                            // æ”¶åˆ°å†…å®¹æ—¶å°±ç›´æ¥å°†è¿ç»­æ¢è¡Œç¬¦æ›¿æ¢ä¸ºå•ä¸ªæ¢è¡Œç¬¦
                                            const content = data.content.replace(/\n\n/g, '\n');
                                            window.currentResponse = (window.currentResponse || '') + content;
                                            
                                            // ä¿å­˜åŸå§‹å†…å®¹
                                            responseElement.dataset.originalContent = window.currentResponse;
                                            
                                            // å°è¯•è§£ææ•´ä¸ªå†…å®¹çš„markdown
                                            try {
                                                responseElement.innerHTML = parseMarkdown(window.currentResponse);
                                            } catch (e) {
                                                // å¦‚æœè§£æå¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºè½¬ä¹‰åçš„åŸå§‹å†…å®¹
                                                responseElement.innerHTML = escapeHtml(window.currentResponse);
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('è§£æå“åº”å¤±è´¥:', e);
                                }
                            }
                        }
                    }
                } else {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model_type: modelType,
                            api_key: apiKey,
                            model: model,
                            prompt: prompt,
                            enable_streaming: false,
                            include_reasoning: true,
                            context: context
                        })
                    });

                    const data = await response.json();
                    const responseElement = aiMessage.querySelector('pre');
                    const reasoningElement = aiMessage.querySelector('div[id^="ai-reasoning"]');
                    
                    if (data.success) {
                        responseElement.textContent = data.response;
                        if (data.reasoning) {
                            responseElement.innerHTML = parseMarkdown(data.response);
                            reasoningElement.innerHTML = `
                                <div class="text-slate-400">
                                    <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                        <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: rotate(0deg)">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                        æ€è€ƒè¿‡ç¨‹
                                    </div>
                                    <div class="pl-5 mt-2 reasoning-content" style="height: 0">
                                        <pre class="whitespace-pre-wrap">${data.reasoning}</pre>
                                    </div>
                                </div>`;
                        } else {
                            reasoningElement.remove();
                        }
                        // åœ¨æˆåŠŸæ—¶ä¿å­˜èŠå¤©è®°å½•
                        saveChatHistory();
                    } else {
                        responseElement.textContent = 'é”™è¯¯: ' + data.error;
                        responseElement.classList.add('text-red-500');
                        reasoningElement.remove();
                    }
                }
            } catch (error) {
                // ç§»é™¤å‘¼å¸ç¯æ•ˆæœ
                document.querySelector('button[type="submit"]').classList.remove('breathing-button');
                const responseElement = aiMessage.querySelector('pre');
                responseElement.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
                responseElement.classList.add('text-red-500');
            }
        }

        // ç›‘å¬å›è½¦é”®å‘é€æ¶ˆæ¯
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            // å¦‚æœæ­£åœ¨ä½¿ç”¨è¾“å…¥æ³•ï¼ˆIMEï¼‰ï¼Œä¸å¤„ç†å›è½¦äº‹ä»¶
            if (e.isComposing || e.keyCode === 229) {
                return;
            }
            
            // å¦‚æœæŒ‰ä¸‹çš„æ˜¯å›è½¦é”®ï¼Œä½†åŒæ—¶æŒ‰ç€ Shift é”®ï¼Œåˆ™å…è®¸æ¢è¡Œ
            if (e.key === 'Enter' && e.shiftKey) {
                return;
            }
            
            // å¦‚æœæŒ‰ä¸‹çš„æ˜¯å›è½¦é”®
            if (e.key === 'Enter') {
                // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
                e.preventDefault();
                
                // è·å–å½“å‰è¾“å…¥çš„å†…å®¹
                const content = this.value.trim();
                
                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæˆ–è€…å†…å®¹åªåŒ…å«æ¢è¡Œç¬¦ï¼Œåˆ™ä¸å‘é€
                if (!content || content.length === 0) {
                    return;
                }
                
                // å¦‚æœæœ€åä¸€æ¬¡æŒ‰é”®åˆ°ç°åœ¨çš„æ—¶é—´å°äº 500msï¼Œåˆ™ä¸å‘é€
                // è¿™å¯ä»¥é˜²æ­¢ç”¨æˆ·åœ¨å¿«é€Ÿè¾“å…¥æ—¶æ„å¤–è§¦å‘å‘é€
                if (this.lastKeyTime && Date.now() - this.lastKeyTime < 500) {
                    return;
                }
                
                // è®°å½•è¿™æ¬¡æŒ‰é”®çš„æ—¶é—´
                this.lastKeyTime = Date.now();
                
                // å‘é€æ¶ˆæ¯
                sendMessage();
            }
        });

        // å¤„ç† API Key å˜åŒ–
        function handleApiKeyChange() {
            const modelType = document.getElementById('modelType').value;
            const apiKey = document.getElementById('apiKey').value;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            config[`${modelType}_apiKey`] = apiKey;
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
            
            // æ›´æ–°ä»£ç ç¤ºä¾‹
            requestAnimationFrame(() => {
                updateCodeExamples();
            });
            
            // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
            if (modelType === 'ollama' || ['openai', 'dashscope', 'deepseek', 'siliconflow'].includes(modelType)) {
                refreshModels();
            }
        }

        // ä¿®æ”¹æŠ˜å /å±•å¼€åŠŸèƒ½
        function toggleReasoning(element) {
            const content = element.nextElementSibling;
            const arrow = element.querySelector('.reasoning-arrow');
            
            if (content.style.height === '0px' || content.style.height === '0') {
                content.style.height = content.scrollHeight + 'px';
                arrow.style.transform = 'rotate(90deg)';
                // è®¾ç½®ä¸€ä¸ªå»¶æ—¶ï¼Œç­‰è¿‡æ¸¡åŠ¨ç”»å®Œæˆåè®¾ç½®ä¸º auto
                setTimeout(() => {
                    content.style.height = 'auto';
                }, 300);
            } else {
                // å…ˆè®¾ç½®ä¸ºå…·ä½“é«˜åº¦ï¼Œä»¥ä¾¿åŠ¨ç”»
                content.style.height = content.scrollHeight + 'px';
                // å¼ºåˆ¶é‡ç»˜
                content.offsetHeight;
                // ç„¶åè®¾ç½®ä¸º 0
                content.style.height = '0';
                arrow.style.transform = 'rotate(0deg)';
            }
            
            // ä¿å­˜çŠ¶æ€
            saveChatHistory();
        }

        // ä¿®æ”¹é‡æ–°å‘èµ·å¯¹è¯å‡½æ•°
        function reaskQuestion(button) {
            const aiMessage = button.closest('.flex.items-start');
            const userMessage = aiMessage.previousElementSibling;
            const pElement = userMessage.querySelector('p');
            // ä½¿ç”¨åŸå§‹å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°æ˜¾ç¤ºå†…å®¹
            const prompt = pElement.dataset.originalContent || pElement.innerHTML.replace(/<br\s*\/?>/g, '\n');
            
            // æ”¶é›†ä¹‹å‰çš„æ‰€æœ‰å¯¹è¯å†…å®¹
            const messageList = document.getElementById('messageList');
            const context = [];
            const messages = messageList.children;
            
            // éå†åˆ°å½“å‰æ¶ˆæ¯ä¸ºæ­¢çš„æ‰€æœ‰æ¶ˆæ¯
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                // å¦‚æœåˆ°è¾¾å½“å‰ç”¨æˆ·æ¶ˆæ¯ï¼Œå°±åœæ­¢
                if (message === userMessage) {
                    break;
                }
                
                if (message.querySelector('.bg-blue-600')) {  // ç”¨æˆ·æ¶ˆæ¯
                    const pElement = message.querySelector('p');
                    context.push({
                        role: 'user',
                        content: pElement.dataset.originalContent || pElement.innerHTML.replace(/<br\s*\/?>/g, '\n')
                    });
                } else if (message.querySelector('.bg-purple-600')) {  // AI æ¶ˆæ¯
                    const responseElement = message.querySelector('pre');
                    // ä½¿ç”¨ dataset.originalContent è·å–åŸå§‹å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ textContent
                    const content = responseElement.dataset.originalContent || responseElement.textContent;
                    if (content && content !== '...') {
                        context.push({
                            role: 'assistant',
                            content: content
                        });
                    }
                }
            }
            
            // è®¾ç½®è¾“å…¥æ¡†å†…å®¹
            document.getElementById('prompt').value = prompt;
            
            // ç§»é™¤å½“å‰çš„ AI å›å¤å’Œç”¨æˆ·æ¶ˆæ¯
            aiMessage.remove();
            userMessage.remove();
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„èŠå¤©è®°å½•
            const storedMessages = JSON.parse(localStorage.getItem('aiPaletteChatHistory') || '[]');
            // ç§»é™¤æœ€åä¸¤æ¡æ¶ˆæ¯ï¼ˆå½“å‰çš„ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ï¼‰
            storedMessages.splice(-2, 2);
            localStorage.setItem('aiPaletteChatHistory', JSON.stringify(storedMessages));
            
            // æ¸…é™¤ä¹‹å‰çš„æ¨ç†å†…å®¹
            window.currentReasoning = '';
            
            // ä¿å­˜ä¸Šä¸‹æ–‡åˆ°å…¨å±€å˜é‡ï¼Œä¾›sendMessageä½¿ç”¨
            window.reaskContext = context;
            
            sendMessage();
        }
        
        // æ¸…ç©ºå…¨éƒ¨å¯¹è¯
        function clearAllMessages() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨å¯¹è¯å—ï¼Ÿ')) {
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨ä¸­çš„èŠå¤©è®°å½•
                localStorage.removeItem('aiPaletteChatHistory');
                // æ¸…ç©ºé¡µé¢å†…å®¹å¹¶æ˜¾ç¤ºæ¨è
                restoreChatHistory();
            }
        }

        // ä¿®æ”¹å¤åˆ¶å“åº”å†…å®¹å‡½æ•°
        function copyResponse(button) {
            const aiMessage = button.closest('.flex.items-start');
            const responseElement = aiMessage.querySelector('pre');
            
            // è·å–åŸå§‹å†…å®¹ï¼ˆmarkdown æ ¼å¼ï¼‰
            const originalContent = responseElement.dataset.originalContent || responseElement.textContent;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(originalContent).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const originalTitle = button.title;
                button.title = 'å¤åˆ¶æˆåŠŸ!';
                setTimeout(() => {
                    button.title = originalTitle;
                }, 1000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.title = 'å¤åˆ¶å¤±è´¥';
            });
        }

        // ä½¿ç”¨æç¤ºè¯å¹¶ç›´æ¥å‘é€
        function usePromptAndSend(button) {
            document.getElementById('prompt').value = button.textContent.trim();
            // éšè—å»ºè®®æ¡†
            document.getElementById('suggestionBox').style.display = 'none';
            // ç›´æ¥å‘é€æ¶ˆæ¯
            sendMessage();
        }

        // ä¿®æ”¹æ·»åŠ AIæ¶ˆæ¯çš„éƒ¨åˆ†
        function addAIMessage(message) {
            const modelType = document.getElementById('modelType').value;
            const model = document.getElementById('model').value;
            const modelInfo = `${modelType.toUpperCase()} / ${model}`;
            
            const aiMessage = document.createElement('div');
            aiMessage.className = 'flex items-start space-x-3 mb-4';
            aiMessage.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 text-white">AI</div>
                <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                    <div class="text-xs dark:text-slate-400 text-slate-500 mb-2">${modelInfo}</div>
                    <div class="dark:text-slate-400 text-slate-500 text-sm mb-2" id="ai-reasoning-${Date.now()}"></div>
                    <pre class="dark:text-slate-200 text-slate-700 whitespace-pre-wrap" id="ai-response-${Date.now()}">...</pre>
                    <div class="flex justify-end space-x-2 mt-2 dark:text-slate-400 text-slate-500">
                        <button onclick="copyResponse(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="å¤åˆ¶å†…å®¹">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                        <button onclick="reaskQuestion(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="é‡æ–°å‘èµ·å¯¹è¯">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                        <button onclick="deleteMessage(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="åˆ é™¤è¿™ä¸€è½®å¯¹è¯">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            return aiMessage;
        }

        // åˆ é™¤å½“å‰å¯¹è¯è½®æ¬¡
        function deleteMessage(button) {
            const aiMessage = button.closest('.flex.items-start');
            const userMessage = aiMessage.previousElementSibling;
            if (userMessage && userMessage.querySelector('.bg-blue-600')) {
                userMessage.remove();
            }
            aiMessage.remove();
            
            // æ›´æ–°å­˜å‚¨çš„èŠå¤©è®°å½•
            saveChatHistory();
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œæ˜¾ç¤ºæ¨è
            const messageList = document.getElementById('messageList');
            if (messageList.children.length === 0) {
                restoreChatHistory();
            }
        }

        // æ·»åŠ ä¸»é¢˜åˆ‡æ¢å‡½æ•°
        function toggleTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeButtons(theme);
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            config.theme = theme;
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
        }

        // æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
        function updateThemeButtons(activeTheme) {
            const darkButton = document.querySelector('.dark-toggle');
            const lightButton = document.querySelector('.light-toggle');
            
            if (activeTheme === 'dark') {
                darkButton.classList.add('bg-blue-600', 'text-slate-50');
                darkButton.classList.remove('dark:text-slate-300', 'text-slate-500');
                lightButton.classList.remove('bg-blue-600', 'text-slate-50');
                lightButton.classList.add('dark:text-slate-300', 'text-slate-500');
            } else {
                lightButton.classList.add('bg-blue-600', 'text-slate-50');
                lightButton.classList.remove('dark:text-slate-300', 'text-slate-500');
                darkButton.classList.remove('bg-blue-600', 'text-slate-50');
                darkButton.classList.add('dark:text-slate-300', 'text-slate-500');
            }
        }

        // ä¿®æ”¹ä¿å­˜èŠå¤©è®°å½•å‡½æ•°
        function saveChatHistory() {
            const messageList = document.getElementById('messageList');
            const messages = [];
            
            for (const message of messageList.children) {
                if (message.id === 'suggestionBox') continue;
                
                if (message.querySelector('.bg-blue-600')) { // ç”¨æˆ·æ¶ˆæ¯
                    const pElement = message.querySelector('p');
                    messages.push({
                        type: 'user',
                        content: pElement.dataset.originalContent || pElement.textContent.replace(/<br\s*\/?>/g, '\n')
                    });
                } else if (message.querySelector('.bg-purple-600')) { // AI æ¶ˆæ¯
                    const modelInfo = message.querySelector('.text-xs').textContent;
                    const responseElement = message.querySelector('pre');
                    const reasoningElement = message.querySelector('div[id^="ai-reasoning"]');
                    
                    const messageData = {
                        type: 'ai',
                        modelInfo: modelInfo,
                        content: responseElement.dataset.originalContent || responseElement.textContent
                    };

                    // å¦‚æœæœ‰æ¨ç†å†…å®¹ï¼Œä¹Ÿä¿å­˜
                    const reasoningContent = reasoningElement?.querySelector('.reasoning-content');
                    if (reasoningContent) {
                        const reasoningDiv = reasoningContent.querySelector('div');
                        messageData.reasoning = reasoningDiv.dataset.originalContent || reasoningDiv.textContent;
                        // ä¿å­˜å±•å¼€/æŠ˜å çŠ¶æ€
                        messageData.reasoningExpanded = reasoningContent.style.height !== '0px' && reasoningContent.style.height !== '0';
                    }

                    messages.push(messageData);
                }
            }
            
            localStorage.setItem('aiPaletteChatHistory', JSON.stringify(messages));
        }

        // æ·»åŠ æ¢å¤èŠå¤©è®°å½•çš„å‡½æ•°
        function restoreChatHistory() {
            const messageList = document.getElementById('messageList');
            if (!messageList) return;
            
            // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
            messageList.innerHTML = '';
            
            // ä» localStorage è·å–æ¶ˆæ¯å†å²
            const messages = JSON.parse(localStorage.getItem('aiPaletteChatHistory') || '[]');
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å†å²æˆ–æ¶ˆæ¯ä¸æ˜¯æ•°ç»„ï¼Œæ˜¾ç¤ºå»ºè®®æ¡†
            if (!Array.isArray(messages) || messages.length === 0) {
                if (!document.getElementById('suggestionBox')) {
                    messageList.innerHTML = `
                        <div id="suggestionBox" class="mb-4">
                            <div class="flex flex-wrap gap-2 text-xs">
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¸®æˆ‘åˆ¶å®šä¸€ä»½ä¸€å‘¨å¥åº·é¥®é£Ÿè®¡åˆ’
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¦‚ä½•ç¼“è§£å·¥ä½œå‹åŠ›å’Œæƒ…ç»ª
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    æ¨èä¸€äº›å®¤å†…æ¤ç‰©å…»æŠ¤å°æŠ€å·§
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    åˆ†äº«ä¸€äº›æé«˜ç¡çœ è´¨é‡çš„æ–¹æ³•
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    æ¨èå‡ é“ç®€å•ç¾å‘³çš„å®¶å¸¸èœ
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    å¦‚ä½•æ•´ç†å’Œæ”¶çº³å°æˆ·å‹ç©ºé—´
                                </button>
                                <button onclick="usePromptAndSend(this)" class="rounded-lg dark:bg-slate-800 bg-white px-3 py-1.5 dark:hover:bg-blue-600 hover:bg-blue-50 dark:hover:text-slate-200 hover:text-blue-600 dark:text-slate-300 text-slate-600 dark:border-slate-700 border-slate-200 border">
                                    åˆ†äº«ä¸€äº›çœé’±å°å¦™æ‹›
                                </button>
                            </div>
                        </div>`;
                }
                return;
            }
            
            // æœ‰æ•ˆçš„æ¶ˆæ¯å†å²ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
            for (const message of messages) {
                if (message.type === 'user') {
                    const userMessage = document.createElement('div');
                    userMessage.className = 'flex items-start space-x-3 mb-4';
                    // å…ˆè½¬ä¹‰å†…å®¹ï¼Œå†å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º <br/>
                    const escapedContent = escapeHtml(message.content);
                    const displayContent = escapedContent.replace(/\n/g, '<br/>');
                    userMessage.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0 text-white">U</div>
                        <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                            <p class="dark:text-slate-200 text-slate-700" data-original-content="${escapeHtml(message.content)}">${displayContent}</p>
                        </div>
                    `;
                    messageList.appendChild(userMessage);
                } else if (message.type === 'ai') {
                    const aiMessage = document.createElement('div');
                    aiMessage.className = 'flex items-start space-x-3 mb-4';
                    
                    let reasoningHtml = '';
                    if (message.reasoning) {
                        const arrowRotation = message.reasoningExpanded ? 'rotate(90deg)' : 'rotate(0deg)';
                        const contentHeight = message.reasoningExpanded ? 'auto' : '0';
                        reasoningHtml = `
                            <div class="text-slate-400">
                                <div class="flex items-center cursor-pointer hover:text-slate-300 transition-colors duration-200" onclick="toggleReasoning(this)">
                                    <svg class="w-4 h-4 mr-1 reasoning-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="transform: ${arrowRotation}">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                    <span class="thinking-label thinking-done">æ€è€ƒè¿‡ç¨‹</span>
                                </div>
                                <div class="pl-5 mt-2 reasoning-content" style="height: ${contentHeight}; transition: height 0.3s">
                                    <div class="whitespace-pre-wrap text-slate-400" data-original-content="${escapeHtml(message.reasoning)}">${parseMarkdown(message.reasoning)}</div>
                                </div>
                            </div>`;
                    }

                    aiMessage.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center flex-shrink-0 text-white">AI</div>
                        <div class="flex-1 dark:bg-slate-800 bg-white rounded-lg p-4 dark:border-slate-700 border-slate-200 border">
                            <div class="text-xs dark:text-slate-400 text-slate-500 mb-2">${escapeHtml(message.modelInfo)}</div>
                            <div class="dark:text-slate-400 text-slate-500 text-sm mb-2" id="ai-reasoning-${Date.now()}">${reasoningHtml}</div>
                            <pre class="dark:text-slate-200 text-slate-700 whitespace-pre-wrap" data-original-content="${escapeHtml(message.content)}">${parseMarkdown(message.content)}</pre>
                            <div class="flex justify-end space-x-2 mt-2 dark:text-slate-400 text-slate-500">
                                <button onclick="copyResponse(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="å¤åˆ¶å†…å®¹">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <button onclick="reaskQuestion(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="é‡æ–°å‘èµ·å¯¹è¯">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button onclick="deleteMessage(this)" class="p-1.5 dark:hover:bg-slate-700 hover:bg-slate-100 rounded-lg" title="åˆ é™¤è¿™ä¸€è½®å¯¹è¯">
                                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    messageList.appendChild(aiMessage);
                }
            }
        }

        // ä»£ç æŠ½å±‰ç›¸å…³å‡½æ•°
        function toggleCodeDrawer() {
            const drawer = document.getElementById('codeDrawer');
            const chatContainer = document.getElementById('chatContainer');
            const checkbox = document.getElementById('showCodeExamples');
            
            drawer.classList.toggle('translate-x-full');
            chatContainer.classList.toggle('drawer-open');
            
            // åŒæ­¥ checkbox çŠ¶æ€
            checkbox.checked = !drawer.classList.contains('translate-x-full');
            
            // è§¦å‘çª—å£ resize äº‹ä»¶ä»¥æ›´æ–°å¸ƒå±€
            window.dispatchEvent(new Event('resize'));
        }
        
        // å¤åˆ¶ä»£ç å‡½æ•°
        function copyCode(button) {
            const pre = button.closest('.relative').querySelector('pre');
            const code = pre.querySelector('code').innerText;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.innerText;
                button.innerText = 'å·²å¤åˆ¶';
                button.classList.add('dark:bg-green-700', 'bg-green-100', 'dark:text-green-100', 'text-green-700');
                
                setTimeout(() => {
                    button.innerText = originalText;
                    button.classList.remove('dark:bg-green-700', 'bg-green-100', 'dark:text-green-100', 'text-green-700');
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                button.innerText = 'å¤åˆ¶å¤±è´¥';
                button.classList.add('dark:bg-red-700', 'bg-red-100', 'dark:text-red-100', 'text-red-700');
                
                setTimeout(() => {
                    button.innerText = 'å¤åˆ¶ä»£ç ';
                    button.classList.remove('dark:bg-red-700', 'bg-red-100', 'dark:text-red-100', 'text-red-700');
                }, 2000);
            });
        }
        
        // æ›´æ–°ä»£ç ç¤ºä¾‹ä¸­çš„é…ç½®
        function updateCodeExamples() {
            const modelType = document.getElementById('modelType').value;
            const model = document.getElementById('model').value;
            const apiKey = document.getElementById('apiKey').value;
            const enableStreaming = document.getElementById('enableStreaming').checked;
            
            // æ›´æ–°æ‰€æœ‰ä»£ç å—ä¸­çš„é…ç½®
            document.querySelectorAll('.code-block code').forEach(codeElement => {
                let code = codeElement.innerText;
                
                // JavaScript ä»£ç æ›´æ–°
                if (codeElement.classList.contains('language-javascript')) {
                    // Fetch API ä»£ç æ›´æ–°
                    if (code.includes('fetch')) {
                        code = code.replace(/model_type:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `model_type: '${modelType}',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\n`);
                        code = code.replace(/model:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `model: '${model}',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹\n`);
                        code = code.replace(/api_key:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `api_key: '${apiKey}',  // å½“å‰è¾“å…¥çš„ API Key\n`);
                        code = code.replace(/enable_streaming:\s*[^,\n}]*(\s*\/\/[^\n]*\n|\s*\n|\s*})/, `enable_streaming: ${enableStreaming}  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º\n`);
                    }
                    // EventSource ä»£ç æ›´æ–°
                    else if (code.includes('EventSource')) {
                        code = code.replace(/model_type:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `model_type: '${modelType}',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\n`);
                        code = code.replace(/model:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `model: '${model}',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹\n`);
                        code = code.replace(/api_key:\s*[^,\n]*,(\s*\/\/[^\n]*\n|\s*\n)/, `api_key: '${apiKey}',  // å½“å‰è¾“å…¥çš„ API Key\n`);
                        code = code.replace(/enable_streaming:\s*[^,\n}]*(\s*\/\/[^\n]*\n|\s*\n|\s*})/, `enable_streaming: true  // æµå¼è¾“å‡ºå§‹ç»ˆå¯ç”¨\n`);
                    }
                } 
                // Python ä»£ç æ›´æ–°
                else if (codeElement.classList.contains('language-python')) {
                    // å‰ç«¯ requests ä»£ç æ›´æ–°
                    if (code.includes('requests.post')) {
                        code = code.replace(/'model_type':\s*[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `'model_type': '${modelType}',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\n`);
                        code = code.replace(/'model':\s*[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `'model': '${model}',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹\n`);
                        code = code.replace(/'api_key':\s*[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `'api_key': '${apiKey}',  # å½“å‰è¾“å…¥çš„ API Key\n`);
                        code = code.replace(/'enable_streaming':\s*[^,\n}]*(\s*#[^\n]*\n|\s*\n|\s*})/, `'enable_streaming': ${enableStreaming ? 'True' : 'False'}  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º\n`);
                    }
                    // åç«¯ AIChat ä»£ç æ›´æ–°
                    else if (code.includes('AIChat')) {
                        code = code.replace(/provider=[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `provider='${modelType}',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\n`);
                        code = code.replace(/model=[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `model='${model}',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹\n`);
                        code = code.replace(/api_key=[^,\n]*,(\s*#[^\n]*\n|\s*\n)/, `api_key='${apiKey}',  # å½“å‰è¾“å…¥çš„ API Key\n`);
                        code = code.replace(/enable_streaming=[^)\n]*(\s*#[^\n]*\n|\s*\n|\s*})/, `enable_streaming=${enableStreaming ? 'True' : 'False'}  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º\n`);
                    }
                } 
                // cURL ä»£ç æ›´æ–°
                else if (codeElement.classList.contains('language-bash')) {
                    code = code.replace(/"model_type":\s*[^,\n}]*,(\s*\/\/[^\n]*\n|\s*\n)/, `"model_type": "${modelType}",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹\n`);
                    code = code.replace(/"model":\s*[^,\n}]*,(\s*\/\/[^\n]*\n|\s*\n)/, `"model": "${model}",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹\n`);
                    code = code.replace(/"api_key":\s*[^,\n}]*,(\s*\/\/[^\n]*\n|\s*\n)/, `"api_key": "${apiKey}",  // å½“å‰è¾“å…¥çš„ API Key\n`);
                    code = code.replace(/"enable_streaming":\s*[^,\n}]*(\s*\/\/[^\n]*\n|\s*\n|\s*})/, `"enable_streaming": ${enableStreaming}  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º\n`);
                }
                
                // ç¡®ä¿æ¯è¡Œåé¢éƒ½æœ‰æ¢è¡Œç¬¦
                code = code.replace(/([^,\n}])(\/\/|#)([^\n]*)/g, '$1\n$2$3');
                code = code.replace(/,(\s*)(\/\/|#)([^\n]*)/g, ',\n$2$3');
                
                codeElement.innerText = code;
            });
        }
        
        // åˆ‡æ¢ä»£ç ç¤ºä¾‹å‡½æ•°
        function switchCodeExample(type) {
            const selectedType = document.getElementById(`${type}CodeType`).value;
            const examples = document.querySelectorAll(`#${type}Examples .code-example`);
            
            // éšè—æ‰€æœ‰ç¤ºä¾‹
            examples.forEach(example => {
                example.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„ç¤ºä¾‹
            const selectedExample = document.getElementById(`${selectedType}Example`);
            if (selectedExample) {
                selectedExample.classList.remove('hidden');
                
                // è·å–ä»£ç å…ƒç´ 
                const codeElement = selectedExample.querySelector('code');
                if (codeElement) {
                    const config = {
                        modelType: document.getElementById('modelType').value,
                        model: document.getElementById('model').value,
                        apiKey: document.getElementById('apiKey').value,
                        enableStreaming: document.getElementById('enableStreaming').checked
                    };

                    // æ ¹æ®ä¸åŒè¯­è¨€é€‰æ‹©æ¨¡æ¿
                    let template;
                    if (selectedType === 'eventsource') {
                        template = CODE_TEMPLATES.eventsource;
                    } else if (selectedType === 'fetch') {
                        template = CODE_TEMPLATES.fetch;
                    } else if (selectedType === 'requests') {
                        template = CODE_TEMPLATES.requests;
                    } else if (selectedType === 'curl') {
                        template = CODE_TEMPLATES.curl;
                    }

                    if (template) {
                        codeElement.textContent = updateCodeWithTemplate(template, config);
                    }
                }
            }
        }

        // ç›‘å¬é…ç½®å˜åŒ–
        function setupConfigListeners() {
            // ç›‘å¬æ‰€æœ‰é…ç½®é¡¹çš„å˜åŒ–
            const configElements = [
                {id: 'modelType', events: ['change']},
                {id: 'model', events: ['change', 'input']},
                {id: 'apiKey', events: ['change', 'input', 'blur']},
                {id: 'enableStreaming', events: ['change']}
            ];

            configElements.forEach(({id, events}) => {
                const element = document.getElementById(id);
                if (element) {
                    events.forEach(eventType => {
                        element.addEventListener(eventType, () => {
                            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§æ›´æ–°,é¿å…æ€§èƒ½é—®é¢˜
                            requestAnimationFrame(() => {
                                updateCodeExamples();
                            });
                        });
                    });
                }
            });

            // ç‰¹åˆ«å¤„ç†æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨ç‚¹å‡»é€‰æ‹©äº‹ä»¶
            document.getElementById('modelList')?.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV' && !e.target.id) {
                    requestAnimationFrame(() => {
                        updateCodeExamples();
                    });
                }
            });
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // åˆå§‹åŒ–ä»£ç ç¤ºä¾‹
            updateCodeExamples();
            // åˆå§‹åŒ–å‰ç«¯ä»£ç ç¤ºä¾‹åˆ‡æ¢
            switchCodeExample('frontend');
            // è®¾ç½®é…ç½®ç›‘å¬
            setupConfigListeners();
            
            // ç›‘å¬ä¸»é¢˜åˆ‡æ¢,ç¡®ä¿ä»£ç ç¤ºä¾‹æ ·å¼åŒæ­¥
            const observer = new MutationObserver(() => {
                requestAnimationFrame(() => {
                    updateCodeExamples();
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['class']
            });
            
            // åˆå§‹åŒ–ååˆ·æ–°æ¨¡å‹åˆ—è¡¨
            refreshModels();
        });

        // å¤„ç†æµå¼è¾“å‡ºå˜åŒ–
        function handleStreamingChange() {
            const enableStreaming = document.getElementById('enableStreaming').checked;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const config = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
            config.enableStreaming = enableStreaming;
            localStorage.setItem('aiPaletteConfig', JSON.stringify(config));
            
            // æ›´æ–°ä»£ç ç¤ºä¾‹
            requestAnimationFrame(() => {
                updateCodeExamples();
            });
        }

        // ä»£ç èŒƒå¼å®šä¹‰
        const CODE_TEMPLATES = {
            fetch: `const response = await fetch('/api/chat', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        model_type: '[$MODEL_TYPE$]',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
        model: '[$MODEL$]',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
        api_key: '[$API_KEY$]',  // å½“å‰è¾“å…¥çš„ API Key
        prompt: 'Your message here',
        enable_streaming: [$STREAMING$]  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
    })
});

const data = await response.json();
console.log(data.response);`,

            eventsource: `const params = new URLSearchParams({
    model_type: '[$MODEL_TYPE$]',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    model: '[$MODEL$]',  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
    api_key: '[$API_KEY$]',  // å½“å‰è¾“å…¥çš„ API Key
    prompt: 'Your message here',
    enable_streaming: true  // æµå¼è¾“å‡ºå§‹ç»ˆå¯ç”¨
});

const eventSource = new EventSource(\`/api/chat?\${params}\`);

eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(data.content);
};

eventSource.onerror = () => {
    eventSource.close();
};`,

            requests: `import requests

response = requests.post(
    'http://localhost:18000/api/chat',
    json={
        'model_type': '[$MODEL_TYPE$]',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
        'model': '[$MODEL$]',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹
        'api_key': '[$API_KEY$]',  # å½“å‰è¾“å…¥çš„ API Key
        'prompt': 'Your message here',
        'enable_streaming': [$STREAMING$]  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
    }
)

print(response.json()['response'])`,

            curl: `curl -X POST http://localhost:18000/api/chat \\
-H "Content-Type: application/json" \\
-d '{
    "model_type": "[$MODEL_TYPE$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    "model": "[$MODEL$]",  // å½“å‰é€‰æ‹©çš„æ¨¡å‹
    "api_key": "[$API_KEY$]",  // å½“å‰è¾“å…¥çš„ API Key
    "prompt": "Your message here",
    "enable_streaming": [$STREAMING$]  // æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
}'`,

            aichat: `from ai_palette import AIChat

# åˆå§‹åŒ–èŠå¤©å®ä¾‹
chat = AIChat(
    provider='[$MODEL_TYPE$]',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹ç±»å‹
    model='[$MODEL$]',  # å½“å‰é€‰æ‹©çš„æ¨¡å‹
    api_key='[$API_KEY$]',  # å½“å‰è¾“å…¥çš„ API Key
    enable_streaming=[$STREAMING$]  # æ˜¯å¦å¯ç”¨æµå¼è¾“å‡º
)`
        };

        // æ›´æ–°ä»£ç ç¤ºä¾‹çš„å‡½æ•°
        function updateCodeWithTemplate(template, config) {
            const isPythonCode = template.includes('import ') || template.includes('AIChat');
            return template
                .replace(/\[\$MODEL_TYPE\$\]/g, config.modelType)
                .replace(/\[\$MODEL\$\]/g, config.model)
                .replace(/\[\$API_KEY\$\]/g, config.apiKey)
                .replace(/\[\$STREAMING\$\]/g, isPythonCode ? (config.enableStreaming ? 'True' : 'False') : config.enableStreaming);
        }

        // åˆ‡æ¢ä»£ç ç¤ºä¾‹å‡½æ•°
        function switchCodeExample(type) {
            const selectedType = document.getElementById(`${type}CodeType`).value;
            const examples = document.querySelectorAll(`#${type}Examples .code-example`);
            
            // éšè—æ‰€æœ‰ç¤ºä¾‹
            examples.forEach(example => {
                example.classList.add('hidden');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„ç¤ºä¾‹
            const selectedExample = document.getElementById(`${selectedType}Example`);
            if (selectedExample) {
                selectedExample.classList.remove('hidden');
                
                // è·å–ä»£ç å…ƒç´ 
                const codeElement = selectedExample.querySelector('code');
                if (codeElement) {
                    const config = {
                        modelType: document.getElementById('modelType').value,
                        model: document.getElementById('model').value,
                        apiKey: document.getElementById('apiKey').value,
                        enableStreaming: document.getElementById('enableStreaming').checked
                    };

                    // æ ¹æ®ä¸åŒè¯­è¨€é€‰æ‹©æ¨¡æ¿
                    let template;
                    if (selectedType === 'eventsource') {
                        template = CODE_TEMPLATES.eventsource;
                    } else if (selectedType === 'fetch') {
                        template = CODE_TEMPLATES.fetch;
                    } else if (selectedType === 'requests') {
                        template = CODE_TEMPLATES.requests;
                    } else if (selectedType === 'curl') {
                        template = CODE_TEMPLATES.curl;
                    }

                    if (template) {
                        codeElement.textContent = updateCodeWithTemplate(template, config);
                    }
                }
            }
        }

        // åŒé“¾æ¨ç†é…ç½®æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
        function toggleChainModal() {
            const modal = document.getElementById('chainModal');
            const modalContent = modal.querySelector('.scale-100, .scale-95');
            
            if (modal.classList.contains('opacity-0')) {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.classList.remove('opacity-0', 'pointer-events-none');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ¡ç›®ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€‰ä¸­ç¬¬ä¸€ä¸ª
                if (!currentChainId) {
                    const firstChainItem = document.querySelector('#chainList li');
                    if (firstChainItem) {
                        const chainId = firstChainItem.dataset.chainId;
                        selectChain(chainId);
                    }
                }
            } else {
                // éšè—æ¨¡æ€æ¡†
                if (modalContent) {
                    modalContent.classList.remove('scale-100');
                    modalContent.classList.add('scale-95');
                }
                setTimeout(() => {
                    modal.classList.add('opacity-0', 'pointer-events-none');
                }, 300);
            }
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
        window.addEventListener('load', () => {
            // åˆå§‹åŒ–æ€è€ƒå’Œç»“æœçš„æ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
            updateModelInputState('thinking', true);
            updateModelInputState('result', true);
            
            // æ¢å¤å·²ä¿å­˜çš„æ¨ç†é“¾æ•°æ®
            const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
            const chainList = document.getElementById('chainList');
            
            // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            chainList.innerHTML = '';
            
            // å¦‚æœæœ‰ä¿å­˜çš„æ¨ç†é“¾ï¼Œåˆ™æ¢å¤å®ƒä»¬
            if (Object.keys(chains).length > 0) {
                Object.entries(chains).forEach(([chainId, chainData]) => {
                    const newChain = document.createElement('li');
                    newChain.className = 'flex items-center justify-between px-3 py-2 rounded-lg dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors duration-200';
                    newChain.dataset.chainId = chainId;
                    
                    newChain.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <span class="flex-1 truncate" ondblclick="makeEditable(this)">${chainData.title}</span>
                            <button onclick="deleteChain(this)" class="ml-2 p-1 rounded-lg dark:hover:bg-slate-600 hover:bg-slate-200 dark:text-slate-400 text-slate-600 flex items-center justify-center">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    newChain.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            selectChain(chainId);
                        }
                    });
                    
                    chainList.appendChild(newChain);
                });
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ¨ç†é“¾ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„
                const chainId = 'chain_' + Date.now();
                const newChain = document.createElement('li');
                newChain.className = 'flex items-center justify-between px-3 py-2 rounded-lg dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors duration-200';
                newChain.dataset.chainId = chainId;
                
                newChain.innerHTML = `
                    <div class="flex items-center justify-between w-full">
                        <span class="flex-1 truncate" ondblclick="makeEditable(this)">æ–°çš„æ¨ç†é“¾</span>
                        <button onclick="deleteChain(this)" class="p-1.5 dark:hover:bg-slate-600 hover:bg-slate-200 dark:text-slate-400 text-slate-600 flex items-center justify-center">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                `;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                newChain.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        selectChain(chainId);
                    }
                });
                
                chainList.appendChild(newChain);
                
                // åˆ›å»ºå¹¶ä¿å­˜é»˜è®¤æ¨ç†é“¾æ•°æ®
                const chainData = {
                    id: chainId,
                    title: 'æ–°çš„æ¨ç†é“¾',
                    thinkingPrompt: '',
                    resultPrompt: '',
                    thinkingConfig: {
                        modelType: 'inherit',
                        model: '',
                        apiKey: ''
                    },
                    resultConfig: {
                        modelType: 'inherit',
                        model: '',
                        apiKey: ''
                    }
                };
                saveChainData(chainData);
                
                // é€‰ä¸­æ–°åˆ›å»ºçš„æ¨ç†é“¾
                selectChain(chainId);
            }
        });

        // æ·»åŠ æ–°çš„æ¨ç†é“¾
        function addNewChain() {
            const chainList = document.getElementById('chainList');
            const newChain = document.createElement('li');
            newChain.className = 'flex items-center justify-between px-3 py-2 rounded-lg dark:bg-slate-700 bg-slate-100 dark:text-slate-300 text-slate-600 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors duration-200';
            
            // ç”Ÿæˆå”¯ä¸€ID
            const chainId = 'chain_' + Date.now();
            newChain.dataset.chainId = chainId;
            
            newChain.innerHTML = `
                <div class="flex items-center justify-between w-full">
                    <span class="flex-1 truncate" ondblclick="makeEditable(this)">æ–°çš„æ¨ç†é“¾</span>
                    <button onclick="deleteChain(this)" class="p-1.5 dark:hover:bg-slate-600 hover:bg-slate-200 dark:text-slate-400 text-slate-600 flex items-center justify-center">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            `;
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            newChain.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    selectChain(chainId);
                }
            });
            
            chainList.appendChild(newChain);
            
            // åˆ›å»ºå¹¶ä¿å­˜ç©ºçš„æ¨ç†é“¾æ•°æ®
            const chainData = {
                id: chainId,
                title: 'æ–°çš„æ¨ç†é“¾',
                thinkingPrompt: '',
                resultPrompt: ''
            };
            saveChainData(chainData);
            
            // é€‰ä¸­æ–°åˆ›å»ºçš„æ¨ç†é“¾
            selectChain(chainId);
        }

        // åˆ é™¤æ¨ç†é“¾
        function deleteChain(button) {
            const chainItem = button.closest('li');
            const chainId = chainItem.dataset.chainId;
            
            // åˆ é™¤æ•°æ®
            const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
            delete chains[chainId];
            localStorage.setItem('aiPaletteChains', JSON.stringify(chains));
            
            chainItem.remove();
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„æ¨ç†é“¾ï¼Œæ¸…ç©ºå³ä¾§å†…å®¹
            if (chainId === currentChainId) {
                document.getElementById('chainTitle').textContent = 'æœªé€‰æ‹©æ¨ç†é“¾';
                document.getElementById('thinkingPrompt').value = '';
                document.getElementById('resultPrompt').value = '';
                currentChainId = null;
            }
        }

        // ä½¿å…ƒç´ å¯ç¼–è¾‘
        function makeEditable(element) {
            if (!element) return;
            
            const chainItem = element.closest('li');
            const isTitle = element.id === 'chainTitle';
            
            // å¦‚æœæ˜¯æ ‡é¢˜ä½†ä¸æ˜¯å½“å‰é€‰ä¸­çš„æ¨ç†é“¾ï¼Œä¸å…è®¸ç¼–è¾‘
            if (isTitle && !currentChainId) return;
            
            // å¦‚æœæ˜¯åˆ—è¡¨é¡¹ä½†æ²¡æœ‰ chainIdï¼Œä¸å…è®¸ç¼–è¾‘
            const chainId = isTitle ? currentChainId : (chainItem?.dataset?.chainId);
            if (!chainId) return;
            
            element.contentEditable = true;
            element.focus();
            
            // ä¿å­˜åŸå§‹å†…å®¹ï¼Œä»¥ä¾¿å–æ¶ˆç¼–è¾‘æ—¶æ¢å¤
            const originalContent = element.textContent;
            
            // ä½¿ç”¨é˜²æŠ–è¿›è¡Œå®æ—¶ä¿å­˜
            let saveTimeout;
            const debouncedSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    const newContent = element.textContent.trim();
                    if (newContent && newContent !== originalContent) {
                        const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
                        if (chains[chainId]) {
                            chains[chainId].title = newContent;
                            localStorage.setItem('aiPaletteChains', JSON.stringify(chains));
                            
                            if (isTitle) {
                                // æ›´æ–°åˆ—è¡¨é¡¹çš„æ ‡é¢˜
                                const listItem = document.querySelector(`li[data-chain-id="${chainId}"] span`);
                                if (listItem) {
                                    listItem.textContent = newContent;
                                }
                            } else {
                                // æ›´æ–°å³ä¾§æ ‡é¢˜
                                const titleElement = document.getElementById('chainTitle');
                                if (titleElement && chainId === currentChainId) {
                                    titleElement.textContent = newContent;
                                }
                            }
                        }
                    }
                }, 300); // 300ms çš„é˜²æŠ–å»¶è¿Ÿ
            };
            
            // ç›‘å¬è¾“å…¥äº‹ä»¶è¿›è¡Œå®æ—¶ä¿å­˜
            element.addEventListener('input', debouncedSave);
            
            // å¤„ç†å›è½¦é”®
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    element.blur();
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶çš„å¤„ç†
            element.addEventListener('blur', () => {
                element.contentEditable = false;
                const newContent = element.textContent.trim();
                
                // å¦‚æœå†…å®¹ä¸ºç©ºï¼Œæ¢å¤åŸå§‹å†…å®¹
                if (!newContent) {
                    element.textContent = originalContent;
                }
                
                // æ¸…é™¤è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
                element.removeEventListener('input', debouncedSave);
            });
        }

        // é€‰æ‹©æ¨ç†é“¾
        let currentChainId = null;
        function selectChain(chainId) {
            // ç§»é™¤å…¶ä»–åˆ—è¡¨é¡¹çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#chainList li').forEach(item => {
                item.classList.remove('dark:bg-blue-600', 'bg-blue-100');
            });
            
            // æ·»åŠ é€‰ä¸­çŠ¶æ€
            const selectedItem = document.querySelector(`li[data-chain-id="${chainId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('dark:bg-blue-600', 'bg-blue-100');
            }
            
            // åŠ è½½æ¨ç†é“¾æ•°æ®
            const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
            const chainData = chains[chainId];
            
            if (chainData) {
                // å¯ç”¨è¾“å…¥æ¡†
                document.getElementById('thinkingPrompt').disabled = false;
                document.getElementById('resultPrompt').disabled = false;
                
                // æ›´æ–°å³ä¾§å†…å®¹
                document.getElementById('chainTitle').textContent = chainData.title;
                document.getElementById('thinkingPrompt').value = chainData.thinkingPrompt || '';
                document.getElementById('resultPrompt').value = chainData.resultPrompt || '';
                
                // åŠ è½½æ¨¡å‹é…ç½®
                if (chainData.thinkingConfig) {
                    document.getElementById('thinkingModelType').value = chainData.thinkingConfig.modelType;
                    document.getElementById('thinkingModel').value = chainData.thinkingConfig.model;
                    document.getElementById('thinkingApiKey').value = chainData.thinkingConfig.apiKey;
                    
                    // æ ¹æ®æ˜¯å¦ç»§æ‰¿è®¾ç½®è¾“å…¥æ¡†çŠ¶æ€
                    updateModelInputState('thinking', chainData.thinkingConfig.modelType === 'inherit');
                }
                
                if (chainData.resultConfig) {
                    document.getElementById('resultModelType').value = chainData.resultConfig.modelType;
                    document.getElementById('resultModel').value = chainData.resultConfig.model;
                    document.getElementById('resultApiKey').value = chainData.resultConfig.apiKey;
                    
                    // æ ¹æ®æ˜¯å¦ç»§æ‰¿è®¾ç½®è¾“å…¥æ¡†çŠ¶æ€
                    updateModelInputState('result', chainData.resultConfig.modelType === 'inherit');
                }
                
                currentChainId = chainId;
                
                // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬
                setupPromptListeners();
            }
        }

        // è®¾ç½® prompt è¾“å…¥ç›‘å¬
        function setupPromptListeners() {
            const thinkingPrompt = document.getElementById('thinkingPrompt');
            const resultPrompt = document.getElementById('resultPrompt');
            const thinkingModelType = document.getElementById('thinkingModelType');
            const thinkingModel = document.getElementById('thinkingModel');
            const thinkingApiKey = document.getElementById('thinkingApiKey');
            const resultModelType = document.getElementById('resultModelType');
            const resultModel = document.getElementById('resultModel');
            const resultApiKey = document.getElementById('resultApiKey');
            
            // é˜²æŠ–å‡½æ•°
            const debounce = (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            };
            
            // ä¿å­˜æ›´æ”¹åˆ° localStorage
            const saveChanges = () => {
                if (currentChainId) {
                    const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
                    if (chains[currentChainId]) {
                        chains[currentChainId].thinkingPrompt = thinkingPrompt.value;
                        chains[currentChainId].resultPrompt = resultPrompt.value;
                        chains[currentChainId].thinkingConfig = {
                            modelType: thinkingModelType.value,
                            model: thinkingModel.value,
                            apiKey: thinkingApiKey.value
                        };
                        chains[currentChainId].resultConfig = {
                            modelType: resultModelType.value,
                            model: resultModel.value,
                            apiKey: resultApiKey.value
                        };
                        localStorage.setItem('aiPaletteChains', JSON.stringify(chains));
                    }
                }
            };
            
            // ä½¿ç”¨é˜²æŠ–å¤„ç†ä¿å­˜
            const debouncedSave = debounce(saveChanges, 300);
            
            // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
            thinkingPrompt.addEventListener('input', debouncedSave);
            resultPrompt.addEventListener('input', debouncedSave);
            thinkingModelType.addEventListener('change', debouncedSave);
            thinkingModel.addEventListener('input', debouncedSave);
            thinkingApiKey.addEventListener('input', debouncedSave);
            resultModelType.addEventListener('change', debouncedSave);
            resultModel.addEventListener('input', debouncedSave);
            resultApiKey.addEventListener('input', debouncedSave);
            
            // å¤„ç†æ¨¡å‹ç±»å‹å˜åŒ–
            thinkingModelType.addEventListener('change', () => {
                const isInherit = thinkingModelType.value === 'inherit';
                updateModelInputState('thinking', isInherit);
                if (!isInherit) {
                    // å…ˆæ¸…ç©ºæ¨¡å‹å’Œkey
                    thinkingModel.value = '';
                    thinkingApiKey.value = '';
                    
                    // åªè‡ªåŠ¨å¡«å…… API Key
                    const mainConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                    const selectedType = thinkingModelType.value;
                    if (mainConfig[`${selectedType}_apiKey`]) {
                        thinkingApiKey.value = mainConfig[`${selectedType}_apiKey`];
                    }
                }
                debouncedSave();
            });
            
            resultModelType.addEventListener('change', () => {
                const isInherit = resultModelType.value === 'inherit';
                updateModelInputState('result', isInherit);
                if (!isInherit) {
                    // å…ˆæ¸…ç©ºæ¨¡å‹å’Œkey
                    resultModel.value = '';
                    resultApiKey.value = '';
                    
                    // åªè‡ªåŠ¨å¡«å…… API Key
                    const mainConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                    const selectedType = resultModelType.value;
                    if (mainConfig[`${selectedType}_apiKey`]) {
                        resultApiKey.value = mainConfig[`${selectedType}_apiKey`];
                    }
                }
                debouncedSave();
            });
        }

        // æ›´æ–°æ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
        function updateModelInputState(type, isInherit) {
            const modelInput = document.getElementById(`${type}Model`);
            const apiKeyInput = document.getElementById(`${type}ApiKey`);
            const modelTypeSelect = document.getElementById(`${type}ModelType`);
            
            if (isInherit) {
                modelInput.disabled = true;
                apiKeyInput.disabled = true;
                modelInput.value = '';
                apiKeyInput.value = '';
                modelInput.placeholder = 'ç»§æ‰¿ä¸»é…ç½®';
                apiKeyInput.placeholder = 'ç»§æ‰¿ä¸»é…ç½®';
                
                // éšè—æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
                if (window[`${type}ModelDropdown`]) {
                    window[`${type}ModelDropdown`].classList.add('hidden');
                }
            } else {
                modelInput.disabled = false;
                apiKeyInput.disabled = false;
                modelInput.placeholder = 'é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°';
                apiKeyInput.placeholder = 'è¾“å…¥ API Key';
                
                // ä»ä¸»é…ç½®è·å–å½“å‰ç±»å‹çš„ API Key
                const mainConfig = JSON.parse(localStorage.getItem('aiPaletteConfig') || '{}');
                const selectedType = modelTypeSelect.value;
                if (mainConfig[`${selectedType}_apiKey`]) {
                    apiKeyInput.value = mainConfig[`${selectedType}_apiKey`];
                }
                
                // è·å–å¹¶æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨
                refreshChainModels(type);
            }
        }

        // åˆ·æ–°æ¨ç†é“¾æ¨¡å‹åˆ—è¡¨
        async function refreshChainModels(type) {
            const modelTypeSelect = document.getElementById(`${type}ModelType`);
            const modelInput = document.getElementById(`${type}Model`);
            const apiKeyInput = document.getElementById(`${type}ApiKey`);
            const modelType = modelTypeSelect.value;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                modelInput.placeholder = 'åŠ è½½ä¸­...';
                modelInput.disabled = true;
                
                const response = await fetch(`/api/models?type=${modelType}&api_key=${apiKeyInput.value}`);
                const data = await response.json();
                
                if (data.success) {
                    // ä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ°å…¨å±€å˜é‡
                    window[`${type}Models`] = data.models || [];
                    
                    // åˆ›å»ºæˆ–æ›´æ–°ä¸‹æ‹‰æ¡†
                    createModelDropdown(type);
                    
                    // å¦‚æœæœ‰æ¨¡å‹ï¼Œæ˜¾ç¤ºä¸‹æ‹‰æ¡†
                    if (window[`${type}Models`].length > 0) {
                        modelInput.placeholder = 'é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§°';
                    } else {
                        modelInput.placeholder = 'æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹';
                    }
                } else {
                    showError(data.error || 'è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');
                    modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                    window[`${type}Models`] = [];
                }
            } catch (error) {
                showError('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + error.message);
                modelInput.placeholder = 'è·å–æ¨¡å‹å¤±è´¥';
                window[`${type}Models`] = [];
            } finally {
                modelInput.disabled = false;
            }
        }

        // åˆ›å»ºæ¨¡å‹ä¸‹æ‹‰æ¡†
        function createModelDropdown(type) {
            const modelInput = document.getElementById(`${type}Model`);
            if (!modelInput) return; // å¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            
            // å¦‚æœä¸‹æ‹‰æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
            let dropdown = window[`${type}ModelDropdown`];
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.id = `${type}ModelDropdown`;
                dropdown.className = 'hidden absolute left-0 right-0 z-50 mt-1 max-h-60 overflow-auto rounded-lg dark:bg-slate-700 bg-white dark:border-slate-600 border-slate-200 border shadow-lg';
                
                // åˆ›å»ºæ¨¡å‹åˆ—è¡¨å®¹å™¨
                const modelList = document.createElement('div');
                modelList.id = `${type}ModelList`;
                modelList.className = 'py-1';
                dropdown.appendChild(modelList);
                
                // å°†ä¸‹æ‹‰æ¡†æ’å…¥åˆ°è¾“å…¥æ¡†åé¢
                modelInput.parentNode.style.position = 'relative';
                modelInput.parentNode.appendChild(dropdown);
                window[`${type}ModelDropdown`] = dropdown;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
                document.addEventListener('click', (e) => {
                    if (!modelInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // æ·»åŠ è¾“å…¥æ¡†ç‚¹å‡»äº‹ä»¶
                modelInput.addEventListener('click', () => {
                    if (window[`${type}Models`]?.length > 0) {
                        updateModelList(type, modelInput.value);
                        dropdown.classList.remove('hidden');
                    }
                });
                
                // æ·»åŠ è¾“å…¥äº‹ä»¶
                modelInput.addEventListener('input', () => {
                    if (window[`${type}Models`]?.length > 0) {
                        updateModelList(type, modelInput.value);
                        dropdown.classList.remove('hidden');
                    }
                });
            }
            
            // ç¡®ä¿ä¸‹æ‹‰æ¡†å’Œåˆ—è¡¨å®¹å™¨å­˜åœ¨åå†æ›´æ–°åˆ—è¡¨
            if (document.getElementById(`${type}ModelList`)) {
                updateModelList(type, modelInput.value);
            }
        }

        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        function updateModelList(type, query) {
            const modelList = document.getElementById(`${type}ModelList`);
            if (!modelList) return; // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            
            const models = window[`${type}Models`] || [];
            const filteredModels = query ? 
                models.filter(model => model.toLowerCase().includes(query.toLowerCase())) : 
                models;
            
            modelList.innerHTML = '';
            
            if (filteredModels.length === 0) {
                const noModels = document.createElement('div');
                noModels.className = 'px-4 py-2 dark:text-slate-400 text-slate-500 text-center';
                noModels.textContent = 'æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹';
                modelList.appendChild(noModels);
                return;
            }
            
            filteredModels.forEach(model => {
                const option = document.createElement('div');
                option.className = 'px-4 py-2 dark:hover:bg-slate-600 hover:bg-slate-100 cursor-pointer dark:text-slate-200 text-slate-700';
                option.textContent = model;
                option.onclick = () => {
                    document.getElementById(`${type}Model`).value = model;
                    window[`${type}ModelDropdown`].classList.add('hidden');
                    // è§¦å‘ä¿å­˜
                    document.getElementById(`${type}Model`).dispatchEvent(new Event('input'));
                };
                modelList.appendChild(option);
            });
        }

        // æ·»åŠ åŒé“¾æ¨ç†é…ç½®æ¨¡æ€æ¡†åˆ‡æ¢å‡½æ•°
        function toggleChainModal() {
            const modal = document.getElementById('chainModal');
            const modalContent = modal.querySelector('.scale-100, .scale-95');
            
            if (modal.classList.contains('opacity-0')) {
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                modal.classList.remove('opacity-0', 'pointer-events-none');
                if (modalContent) {
                    modalContent.classList.remove('scale-95');
                    modalContent.classList.add('scale-100');
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„æ¡ç›®ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€‰ä¸­ç¬¬ä¸€ä¸ª
                if (!currentChainId) {
                    const firstChainItem = document.querySelector('#chainList li');
                    if (firstChainItem) {
                        const chainId = firstChainItem.dataset.chainId;
                        selectChain(chainId);
                    }
                }
            } else {
                // éšè—æ¨¡æ€æ¡†
                if (modalContent) {
                    modalContent.classList.remove('scale-100');
                    modalContent.classList.add('scale-95');
                }
                setTimeout(() => {
                    modal.classList.add('opacity-0', 'pointer-events-none');
                }, 300);
            }
        }

        // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–æ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
        window.addEventListener('load', () => {
            // åˆå§‹åŒ–æ€è€ƒå’Œç»“æœçš„æ¨¡å‹è¾“å…¥æ¡†çŠ¶æ€
            updateModelInputState('thinking', true);
            updateModelInputState('result', true);
            
            // ... å…¶ä»–ç°æœ‰çš„åˆå§‹åŒ–ä»£ç  ...
        });

        // ä¿å­˜æ¨ç†é“¾æ•°æ®
        function saveChainData(chainData) {
            const chains = JSON.parse(localStorage.getItem('aiPaletteChains') || '{}');
            chains[chainData.id] = chainData;
            localStorage.setItem('aiPaletteChains', JSON.stringify(chains));
        }
    </script>
</body>
</html> 